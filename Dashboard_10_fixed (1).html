<!DOCTYPE html>

<html lang="en">
<head><script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Inventory Report Formatter</title>
<script crossorigin="" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin="" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            50: '#F8F8F8',
                            100: '#F0F0F0',
                            200: '#E0E0E0',
                            300: '#D0D0D0',
                            400: '#A0A0A0',
                            500: '#808080',
                            600: '#606060',
                            700: '#404040',
                            800: '#333333',
                        }
                    }
                }
            }
        }
    </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
        body {
            background: #00CCFF;
            margin: 0;
            padding: 0;
        }
        .access-button {
            background: linear-gradient(180deg, #f0f0f0 0%, #d0d0d0 100%);
            border: 1px solid #999;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .access-button:hover {
            background: linear-gradient(180deg, #e8e8e8 0%, #d0d0d0 100%);
        }
        .access-button:active {
            background: linear-gradient(180deg, #d0d0d0 0%, #d0d0d0 100%);
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.3);
        }
        .letter-button {
            min-width: 40px;
            height: 40px;
            background: linear-gradient(180deg, #f0f0f0 0%, #d0d0d0 100%);
            border: 1px solid #999;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            color: #333;
            transition: all 0.1s;
        }
        .letter-button:hover {
            background: linear-gradient(180deg, #e8e8e8 0%, #d0d0d0 100%);
        }
        .letter-button.active {
            background: linear-gradient(180deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            border-color: #2E7D32;
        }
        .access-header {
            background: linear-gradient(180deg, #e0e0e0 0%, #d0d0d0 100%);
            border-bottom: 2px solid #999;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            color: #333;
        }
        /* Drag and drop feedback */
        label.ring-4 {
            box-shadow: 0 0 0 4px rgba(0, 204, 255, 0.5) !important;
            background: linear-gradient(180deg, #e0f5ff 0%, #b3ecff 100%) !important;
        }
        /* Slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2E7D32;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2E7D32;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-section { page-break-after: always; }
            
            /* Print header - shows only at top of document */
            .print-only-header {
                display: block !important;
                text-align: center;
                page-break-after: avoid;
                margin-bottom: 20px;
            }
            
            .print-header-line1 {
                font-weight: bold;
                font-size: 18px;
                margin-bottom: 2px;
            }
            
            .print-header-line2 {
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 2px;
            }
            
            .print-header-line3 {
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 15px;
            }
        }
        
        /* Hide print-only elements on screen */
        .print-only-header {
            display: none;
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
        const { useState } = React;

        // Robust CSV parser handling quoted fields and embedded commas
        function CSVToArray(strData, strDelimiter = ",") {
            const objPattern = new RegExp(
                (
                    "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
                    "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
                    "([^\"\\" + strDelimiter + "\\r\\n]*))"
                ),
                "gi"
            );
            let arrData = [[]];
            let arrMatches = null;
            while ((arrMatches = objPattern.exec(strData))) {
                const strMatchedDelimiter = arrMatches[1];
                if (strMatchedDelimiter.length && strMatchedDelimiter !== strDelimiter) {
                    arrData.push([]);
                }
                const strMatchedValue = arrMatches[2]
                    ? arrMatches[2].replace(new RegExp("\"\"", "g"), "\"")
                    : arrMatches[3];
                arrData[arrData.length - 1].push(strMatchedValue);
            }
            return arrData;
        }

        function InventoryReportFormatter() {
            const [data, setData] = useState([]);
            const [fileName, setFileName] = useState('');
            const [groupedData, setGroupedData] = useState({});
            const [copySuccess, setCopySuccess] = useState(false);
            const [shippedData, setShippedData] = useState({});
            const [shippedFileName, setShippedFileName] = useState('');
            const [selectedLetters, setSelectedLetters] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [showInstructions, setShowInstructions] = useState(false);
            const [showSizeSummary, setShowSizeSummary] = useState(false);
            const [isDraggingInventory, setIsDraggingInventory] = useState(false);
            const [isDraggingShipped, setIsDraggingShipped] = useState(false);
            const [showReservedReport, setShowReservedReport] = useState(false);
            const [reservedPercentageMin, setReservedPercentageMin] = useState(70);
            const [showOnlyPriority1, setShowOnlyPriority1] = useState(false);
            const [showCustomerSales, setShowCustomerSales] = useState(false);
            const [customerSalesData, setCustomerSalesData] = useState([]);
            const [sortCustomerByPrice, setSortCustomerByPrice] = useState(true);
            const [groupBySalesRep, setGroupBySalesRep] = useState(false);
            const [showEmptySalesReps, setShowEmptySalesReps] = useState(false);
            const [showShiftsReport, setShowShiftsReport] = useState(false);
            const [showGroupByRep, setShowGroupByRep] = useState(false);
            const [showMissingRep, setShowMissingRep] = useState(false);
            const [showProductionPlanning, setShowProductionPlanning] = useState(false);
            const [fulfilledSalesData, setFulfilledSalesData] = useState([]);
            const [isDraggingFulfilledSales, setIsDraggingFulfilledSales] = useState(false);
            const [visibleYearColumns, setVisibleYearColumns] = useState(new Set());
            const [yearAverageCount, setYearAverageCount] = useState(3);
            
            // Production Planning column visibility toggles
            const [showShippedYTD, setShowShippedYTD] = useState(true);
            const [showInProductionQty, setShowInProductionQty] = useState(true);
            const [showReadyQty, setShowReadyQty] = useState(true);
            const [showFutureShiftQty, setShowFutureShiftQty] = useState(true);
            const [showProjectedQty, setShowProjectedQty] = useState(true);
            
            // Ready Date grouping toggles
            const [showReadyMonthColumns, setShowReadyMonthColumns] = useState(false);
            const [showReadySeasonColumns, setShowReadySeasonColumns] = useState(false);
            const [visibleReadyMonths, setVisibleReadyMonths] = useState(new Set());
            const [visibleReadySeasons, setVisibleReadySeasons] = useState(new Set());
            
            // Start Date grouping toggles
            const [showStartMonthColumns, setShowStartMonthColumns] = useState(false);
            const [showStartSeasonColumns, setShowStartSeasonColumns] = useState(false);
            const [visibleStartMonths, setVisibleStartMonths] = useState(new Set());
            const [visibleStartSeasons, setVisibleStartSeasons] = useState(new Set());
            
            // Initialize with all months/seasons for 3 years when component mounts
            React.useEffect(() => {
                const currentYear = new Date().getFullYear();
                const years = [currentYear, currentYear + 1, currentYear + 2];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                
                // Initialize all ready date months/seasons
                const allReadyMonths = new Set();
                const allReadySeasons = new Set();
                years.forEach(year => {
                    months.forEach(month => allReadyMonths.add(`${month} ${year}`));
                    seasons.forEach(season => allReadySeasons.add(`${season} ${year}`));
                });
                setVisibleReadyMonths(allReadyMonths);
                setVisibleReadySeasons(allReadySeasons);
                
                // Initialize all start date months/seasons
                const allStartMonths = new Set();
                const allStartSeasons = new Set();
                years.forEach(year => {
                    months.forEach(month => allStartMonths.add(`${month} ${year}`));
                    seasons.forEach(season => allStartSeasons.add(`${season} ${year}`));
                });
                setVisibleStartMonths(allStartMonths);
                setVisibleStartSeasons(allStartSeasons);
            }, []);

            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            // Normalize column names to handle case sensitivity and variations
            const normalizeColumnName = (name) => {
                const normalized = name.toLowerCase().trim();
                
                // Map various column name variations to standard keys
                const columnMap = {
                    'product': 'Product',
                    'variant': 'Variant',
                    'current size': 'Current size',
                    'qty': 'Qty',
                    'quantity': 'Qty',
                    'reserved qty': 'Reserved qty',
                    'reserved quantity': 'Reserved qty',
                    'salable qty': 'Salable qty',
                    'available qty': 'Available qty',
                    'available quantity': 'Available qty',
                    'on-hand qty': 'On-hand qty',
                    'sold qty': 'Sold qty',
                    'withheld qty': 'Withheld qty',
                    'pulled qty': 'Pulled qty',
                    'start date': 'Start date',
                    'status': 'Status',
                    'ready date': 'Ready date',
                    'locations': 'Locations',
                    'location': 'Locations',
                    // Handle "Pull priorty" typo AND the corrected "Pull priority" AND just "Priority"
                    'pull priorty': 'Pull Priorty',
                    'pull priority': 'Pull Priorty',
                    'priority': 'Pull Priorty',
                    'inventory notes': 'Inventory Notes',
                    'notes': 'Inventory Notes',
                    'attributes': 'Attributes',
                    'sales notes': 'Sales notes',
                    'photos': 'Photos',
                    'photo last uploaded': 'Photo last uploaded',
                    'withheld notes': 'Withheld Notes',
                    'confirmed': 'Confirmed',
                    'confirmed qty': 'Confirmed',
                    'allocated': 'Allocated',
                    'sku': 'SKU',
                    'crop code': 'Crop code',
                    // For shipped data CSV
                    'fulfilled': 'Fulfilled'
                };
                
                return columnMap[normalized] || name; // Return original if no mapping found
            };


            const parseCSV = (text) => {
                const arrData = CSVToArray(text);
                if (arrData.length === 0) return { headers: [], rows: [] };

                const headers = arrData[0].map(h => h.trim().replace(/"/g, ''));
                const normalizedHeaders = headers.map(h => normalizeColumnName(h));
                
                const rows = arrData.slice(1).map(row => {
                    const obj = {};
                    normalizedHeaders.forEach((header, idx) => {
                        obj[header] = (row[idx] || '').trim().replace(/"/g, '');
                    });
                    return obj;
                }).filter(row => Object.values(row).some(val => val !== ''));

                return { headers: normalizedHeaders, rows };
            };

            const parseNumeric = (valueStr) => {
                if (!valueStr || valueStr === '') return 0;
                const cleaned = valueStr.toString().replace(/,/g, '');
                const num = parseFloat(cleaned);
                if (isNaN(num)) {
                    return 0;
                }
                return num;
            };

            const buildBlockTitle = (product, variant) => {
                const variantBase = variant.split('|')[0].trim();
                return `${product} ${variantBase}`.trim();
            };

            const getVariantSize = (variant) => {
                const parts = variant.split('|');
                return parts.length > 1 ? parts[1].trim() : '';
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
            };

            const formatMonthYear = (dateStr) => {
                if (!dateStr) return 'UNK';
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return 'UNK';
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            };

            const getCoreLocation = (location) => {
                const lastArrow = location.lastIndexOf('>');
                return lastArrow > -1 ? location.substring(lastArrow + 1).trim() : location;
            };

            const extractContainerSize = (plantName) => {
                const parts = plantName.split('|');
                return parts.length > 1 ? parts[1].trim() : '';
            };

            const compareSizes = (size1, size2) => {
                // Normalize size strings
                const s1 = size1.toLowerCase().trim();
                const s2 = size2.toLowerCase().trim();
                
                // Helper function to get sort order value
                const getSortValue = (size) => {
                    const s = size.toLowerCase().trim();
                    
                    // 21 cell is the smallest
                    if (s.includes('21') && s.includes('cell')) return 0;
                    if (s.includes('insert') && s.includes('21')) return 0;
                    
                    // 4" or 4 inch is second smallest (also catch plain "4")
                    if (s === '4' || s === '4"' || s === '4\"' || s.includes('4 inch') || s === '4in') return 1;
                    
                    // Extract gallon sizes (1G, 2G, 3G, etc.)
                    const gallonMatch = s.match(/(\d+\.?\d*)\s*g/);
                    if (gallonMatch) {
                        return 2 + parseFloat(gallonMatch[1]);
                    }
                    
                    // Try to extract any number
                    const numMatch = s.match(/(\d+\.?\d*)/);
                    if (numMatch) {
                        return 1000 + parseFloat(numMatch[1]);
                    }
                    
                    // Unknown sizes go to the end
                    return 10000;
                };
                
                const val1 = getSortValue(s1);
                const val2 = getSortValue(s2);
                
                if (val1 !== val2) {
                    return val1 - val2;
                }
                
                // If same sort value, use alphabetical
                return s1.localeCompare(s2);
            };

            const sortVariantsBySize = (variants) => {
                const sortedEntries = Object.entries(variants).sort((a, b) => {
                    const size1 = extractContainerSize(a[0]);
                    const size2 = extractContainerSize(b[0]);
                    const sizeComparison = compareSizes(size1, size2);
                    
                    if (sizeComparison === 0) {
                        const getEarliestDate = (rows) => {
                            const dates = rows.map(r => {
                                const dateStr = r.readyDate;
                                if (!dateStr || dateStr.trim() === '') return Infinity;
                                const parts = dateStr.split('/');
                                if (parts.length === 3) {
                                    const year = parseInt(parts[2]) + 2000;
                                    const month = parseInt(parts[0]);
                                    const day = parseInt(parts[1]);
                                    return new Date(year, month - 1, day).getTime();
                                }
                                return Infinity;
                            });
                            return Math.min(...dates);
                        };
                        
                        const date1 = getEarliestDate(a[1]);
                        const date2 = getEarliestDate(b[1]);
                        
                        return date1 - date2;
                    }
                    
                    return sizeComparison;
                });
                
                const sortedVariants = {};
                sortedEntries.forEach(([key, value]) => {
                    sortedVariants[key] = value;
                });
                
                return sortedVariants;
            };

            const processInventoryData = (csvText, currentShippedData) => {
                const { headers, rows } = parseCSV(csvText);
                setData(rows);
                
                const shipped = currentShippedData || shippedData;
                const grouped = {};
                
                rows.forEach(row => {
                    const product = row['Product'] || '';
                    const variant = row['Variant'] || '';
                    const qty = parseNumeric(row['Qty']);
                    const status = row['Status'] || '';
                    const startDate = row['Start date'] || '';
                    
                    if (!product || !variant || qty <= 0 || !status || !startDate) return;

                    const blockTitle = buildBlockTitle(product, variant);
                    const size = getVariantSize(variant);
                    const monthYear = formatMonthYear(startDate);
                    const plantName = `${monthYear} | ${size}`;

                    if (!grouped[blockTitle]) {
                        grouped[blockTitle] = {};
                    }

                    if (!grouped[blockTitle][plantName]) {
                        grouped[blockTitle][plantName] = [];
                    }

                    const statusText = (row['Status'] || '').trim();
                    const displayStatus = statusText.toLowerCase().includes('production') ? 'In prod' : statusText;

                    const variantBase = variant.split('|')[0].trim();
                    const shippedKey = `${product}|${variantBase}|${size}`;
                    const shippedYTD = shipped[shippedKey] || 0;

                    grouped[blockTitle][plantName].push({
                        plantName: plantName,
                        status: displayStatus,
                        originalStatus: statusText,
                        pullPriority: row['Pull Priorty'] || '',
                        locations: getCoreLocation(row['Locations'] || ''),
                        readyDate: formatDate(row['Ready date']),
                        qty: qty,
                        rsrvQty: parseNumeric(row['Reserved qty']),
                        availQty: parseNumeric(row['Available qty']),
                        pullQty: parseNumeric(row['Pulled qty']),
                        shippedYTD: shippedYTD
                    });
                });

                Object.keys(grouped).forEach(plantBlock => {
                    Object.keys(grouped[plantBlock]).forEach(plantName => {
                        const rows = grouped[plantBlock][plantName];
                        
                        if (rows.length > 1) {
                            const combined = {
                                plantName: plantName,
                                status: '',
                                originalStatus: '',
                                pullPriority: '',
                                locations: '',
                                readyDate: '',
                                qty: 0,
                                rsrvQty: 0,
                                availQty: 0,
                                pullQty: 0,
                                shippedYTD: rows[0].shippedYTD
                            };
                            
                            const priorities = new Set();
                            const priorityToLocations = {};
                            let hasReady = false;
                            let earliestDate = null;
                            
                            rows.forEach(r => {
                                combined.qty += r.qty;
                                combined.rsrvQty += r.rsrvQty;
                                combined.availQty += r.availQty;
                                combined.pullQty += r.pullQty;
                                
                                if (r.pullPriority) {
                                    const prioList = r.pullPriority.split(',').map(p => p.trim());
                                    prioList.forEach(p => {
                                        priorities.add(p);
                                        if (!priorityToLocations[p]) {
                                            priorityToLocations[p] = new Set();
                                        }
                                        if (r.locations) {
                                            priorityToLocations[p].add(r.locations);
                                        }
                                    });
                                }
                                
                                if (r.originalStatus.toLowerCase() === 'ready') {
                                    hasReady = true;
                                }
                                
                                if (r.readyDate) {
                                    if (!earliestDate || r.readyDate < earliestDate) {
                                        earliestDate = r.readyDate;
                                    }
                                }
                            });
                            
                            const sortedPriorities = Array.from(priorities).sort((a, b) => {
                                const numA = parseInt(a) || 999;
                                const numB = parseInt(b) || 999;
                                return numA - numB;
                            });
                            
                            const locationParts = [];
                            sortedPriorities.forEach(priority => {
                                const locs = Array.from(priorityToLocations[priority] || []).sort();
                                if (locs.length > 0) {
                                    locationParts.push(locs.join(', '));
                                }
                            });
                            
                            combined.pullPriority = sortedPriorities.join(', ');
                            combined.locations = locationParts.join(', ');
                            combined.readyDate = earliestDate || '';
                            
                            if (hasReady) {
                                combined.status = 'Ready';
                                combined.originalStatus = 'Ready';
                            } else {
                                combined.status = 'In prod';
                                combined.originalStatus = 'In production';
                            }
                            
                            grouped[plantBlock][plantName] = [combined];
                        }
                    });
                });

                setGroupedData(grouped);
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setFileName(file.name);
                const reader = new FileReader();

                reader.onload = (event) => {
                    processInventoryData(event.target.result, shippedData);
                };

                reader.readAsText(file);
            };

            const handleInventoryDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDraggingInventory(true);
            };

            const handleInventoryDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDraggingInventory(false);
            };

            const handleInventoryDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDraggingInventory(false);

                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    setFileName(file.name);
                    const reader = new FileReader();

                    reader.onload = (event) => {
                        processInventoryData(event.target.result, shippedData);
                    };

                    reader.readAsText(file);
                } else {
                    alert('Please drop a CSV file');
                }
            };

            const handleShippedFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setShippedFileName(file.name);
                const reader = new FileReader();

                reader.onload = (event) => {
                    const text = event.target.result;
                    const { headers, rows } = parseCSV(text);
                    
                    const shipped = {};
                    
                    rows.forEach((row, index) => {
                        const product = (row['Product'] || '').trim();
                        const variant = (row['Variant'] || '').trim();
                        const fulfilledRaw = row['Fulfilled'] || '';
                        const fulfilled = parseNumeric(fulfilledRaw);
                        
                        if (!product || !variant || fulfilled <= 0) {
                            return;
                        }

                        const size = getVariantSize(variant);
                        const variantBase = variant.split('|')[0].trim();
                        const key = `${product}|${variantBase}|${size}`;
                        
                        if (!shipped[key]) {
                            shipped[key] = 0;
                        }
                        shipped[key] += fulfilled;
                    });
                    
                    setShippedData(shipped);
                    setCustomerSalesData(rows);
                    
                    if (data.length > 0) {
                        const csvText = [
                            Object.keys(data[0]).join(','),
                            ...data.map(row => Object.values(row).map(v => `"${v}"`).join(','))
                        ].join('\n');
                        processInventoryData(csvText, shipped);
                    }
                };

                reader.readAsText(file);
            };

            const handleShippedDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDraggingShipped(true);
            };

            const handleShippedDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDraggingShipped(false);
            };

            const handleShippedDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDraggingShipped(false);

                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    setShippedFileName(file.name);
                    const reader = new FileReader();

                    reader.onload = (event) => {
                        const text = event.target.result;
                        const { headers, rows } = parseCSV(text);
                        
                        const shipped = {};
                        
                        rows.forEach((row, index) => {
                            const product = (row['Product'] || '').trim();
                            const variant = (row['Variant'] || '').trim();
                            const fulfilledRaw = row['Fulfilled'] || '';
                            const fulfilled = parseNumeric(fulfilledRaw);
                            
                            if (!product || !variant || fulfilled <= 0) {
                                return;
                            }

                            const size = getVariantSize(variant);
                            const variantBase = variant.split('|')[0].trim();
                            const key = `${product}|${variantBase}|${size}`;
                            
                            if (!shipped[key]) {
                                shipped[key] = 0;
                            }
                            shipped[key] += fulfilled;
                        });
                        
                        setShippedData(shipped);
                        
                        setCustomerSalesData(rows);
                        if (data.length > 0) {
                            const csvText = [
                                Object.keys(data[0]).join(','),
                                ...data.map(row => Object.values(row).map(v => `"${v}"`).join(','))
                            ].join('\n');
                            processInventoryData(csvText, shipped);
                        }
                    };

                    reader.readAsText(file);
                } else {
                    alert('Please drop a CSV file');
                }
            };

            const handleFulfilledSalesFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();

                reader.onload = (event) => {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Look for "Sales by Plant Quantity" sheet
                    const sheetName = 'Sales by Plant Quantity';
                    if (!workbook.SheetNames.includes(sheetName)) {
                        alert(`Sheet "${sheetName}" not found in the Excel file. Available sheets: ${workbook.SheetNames.join(', ')}`);
                        return;
                    }
                    
                    const worksheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Filter out rows without SKU# or SKU
                    const filteredRows = rows.filter(row => row['SKU#'] || row['SKU']);
                    
                    setFulfilledSalesData(filteredRows);
                };

                reader.readAsArrayBuffer(file);
            };

            const handleFulfilledSalesDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDraggingFulfilledSales(true);
            };

            const handleFulfilledSalesDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDraggingFulfilledSales(false);
            };

            const handleFulfilledSalesDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDraggingFulfilledSales(false);

                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    const reader = new FileReader();

                    reader.onload = (event) => {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Look for "Sales by Plant Quantity" sheet
                        const sheetName = 'Sales by Plant Quantity';
                        if (!workbook.SheetNames.includes(sheetName)) {
                            alert(`Sheet "${sheetName}" not found in the Excel file. Available sheets: ${workbook.SheetNames.join(', ')}`);
                            return;
                        }
                        
                        const worksheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(worksheet);
                        
                        // Filter out rows without SKU# or SKU
                        const filteredRows = rows.filter(row => row['SKU#'] || row['SKU']);
                        
                        setFulfilledSalesData(filteredRows);
                    };

                    reader.readAsArrayBuffer(file);
                } else {
                    alert('Please drop an Excel file (.xlsx or .xls)');
                }
            };

            const toggleLetter = (letter) => {
                setSelectedLetters(prev => {
                    if (prev.includes(letter)) {
                        return prev.filter(l => l !== letter);
                    } else {
                        return [...prev, letter];
                    }
                });
            };

            const clearAllFilters = () => {
                setSelectedLetters([]);
                setSearchTerm('');
            };

            // Filter grouped data based on selected letters and search term
            const getFilteredData = () => {
                if (selectedLetters.length === 0 && !searchTerm.trim()) {
                    return groupedData;
                }

                const filtered = {};
                Object.keys(groupedData).forEach(plantBlock => {
                    const firstLetter = plantBlock.charAt(0).toUpperCase();
                    const matchesLetter = selectedLetters.length === 0 || selectedLetters.includes(firstLetter);
                    const matchesSearch = !searchTerm.trim() || 
                        plantBlock.toLowerCase().includes(searchTerm.toLowerCase());

                    if (matchesLetter && matchesSearch) {
                        filtered[plantBlock] = groupedData[plantBlock];
                    }
                });

                return filtered;
            };

            const getSizeSummary = () => {
                const sizeTotals = {};
                
                data.forEach(row => {
                    const variant = row['Variant'] || '';
                    const size = getVariantSize(variant); // Extract size from variant
                    const qty = parseNumeric(row['Qty']);
                    
                    if (size && qty > 0) {
                        if (!sizeTotals[size]) {
                            sizeTotals[size] = 0;
                        }
                        sizeTotals[size] += qty;
                    }
                });
                
                // Sort sizes
                const sortedSizes = Object.entries(sizeTotals).sort((a, b) => {
                    return compareSizes(a[0], b[0]);
                });
                
                // Format display names
                const formattedSizes = sortedSizes.map(([size, qty]) => {
                    let displaySize = size;
                    // Format plain "4" as "4\""
                    if (size.trim() === '4') {
                        displaySize = '4"';
                    }
                    return [displaySize, qty];
                });
                
                return formattedSizes;
            };

            const getSizeByStatus = (statusFilter) => {
                const sizeTotals = {};
                
                data.forEach(row => {
                    const variant = row['Variant'] || '';
                    const size = getVariantSize(variant); // Extract size from variant
                    const status = row['Status'] || '';
                    const qty = parseNumeric(row['Qty']);
                    
                    if (size && qty > 0 && status.toLowerCase() === statusFilter.toLowerCase()) {
                        if (!sizeTotals[size]) {
                            sizeTotals[size] = 0;
                        }
                        sizeTotals[size] += qty;
                    }
                });
                
                // Sort sizes
                const sortedSizes = Object.entries(sizeTotals).sort((a, b) => {
                    return compareSizes(a[0], b[0]);
                });
                
                // Format display names
                const formattedSizes = sortedSizes.map(([size, qty]) => {
                    let displaySize = size;
                    // Format plain "4" as "4\""
                    if (size.trim() === '4') {
                        displaySize = '4"';
                    }
                    return [displaySize, qty];
                });
                
                return formattedSizes;
            };

            const getReservedInventoryReport = () => {
                // Group by Product + Variant first
                const grouped = {};
                
                data.forEach(row => {
                    const product = row['Product'] || '';
                    const variant = row['Variant'] || '';
                    const location = row['Locations'] || '';
                    const qty = parseNumeric(row['Qty']);
                    const rsrvQty = parseNumeric(row['Reserved qty']);
                    const pullPriorityStr = (row['Pull Priorty'] || '').trim();
                    const invNotes = (row['Inventory Notes'] || '').toLowerCase();
                    
                    // Skip rows with "Metrolina" in Inventory Notes
                    if (invNotes.includes('metrolina')) return;
                    
                    if (!product || !variant || qty === 0) return;
                    
                    const key = `${product}::${variant}`;
                    
                    if (!grouped[key]) {
                        grouped[key] = {
                            product: product,
                            variant: variant,
                            rows: []
                        };
                    }
                    
                    // Parse priorities - filter out asterisks
                    const priorities = pullPriorityStr.split(',')
                        .map(p => p.trim())
                        .filter(p => p && !p.includes('*'))
                        .map(p => parseInt(p));
                    
                    const coreLocation = location.lastIndexOf('>') > -1 
                        ? location.substring(location.lastIndexOf('>') + 1).trim() 
                        : location;
                    
                    grouped[key].rows.push({
                        location: coreLocation,
                        qty: qty,
                        rsrvQty: rsrvQty,
                        priorities: priorities,
                        percentReserved: (rsrvQty / qty) * 100
                    });
                });
                
                // Build report
                const reportData = [];
                
                Object.values(grouped).forEach(group => {
                    // Collect rows to display for this product
                    const productRows = [];
                    
                    // Find all Priority 1 rows
                    const priority1Rows = group.rows.filter(r => r.priorities.includes(1));
                    
                    // Check if any Priority 1 meets threshold
                    const hasP1MeetingThreshold = priority1Rows.some(r => 
                        r.percentReserved >= reservedPercentageMin && r.percentReserved <= 100
                    );
                    
                    if (!hasP1MeetingThreshold) return; // Skip this product
                    
                    // Add all Priority 1 rows
                    priority1Rows.forEach(row => {
                        productRows.push({
                            description: `${group.product} ${group.variant}`,
                            priority: 1,
                            location: row.location,
                            qty: row.qty,
                            rsrvQty: row.rsrvQty,
                            percentReserved: row.percentReserved
                        });
                    });
                    
                    
                    // If "Show Only Priority 1" is enabled, skip P2+ and finalize now
                    if (showOnlyPriority1) {
                        // Calculate totals for this product (only P1)
                        const totalQty = productRows.reduce((sum, r) => sum + r.qty, 0);
                        const totalRsrvQty = productRows.reduce((sum, r) => sum + r.rsrvQty, 0);
                        
                        // Add rows with totals on last row and blank descriptions after first row
                        productRows.forEach((row, idx) => {
                            reportData.push({
                                ...row,
                                sortKey: row.description, // Keep for sorting
                                description: idx === 0 ? row.description : '',
                                totalQty: idx === productRows.length - 1 ? totalQty : null,
                                totalRsrvQty: idx === productRows.length - 1 ? totalRsrvQty : null
                            });
                        });
                        return; // Skip P2+ processing
                    }
                    // Add all Priority 2 rows (if they exist)
                    const priority2Rows = group.rows.filter(r => r.priorities.includes(2));
                    priority2Rows.forEach(row => {
                        productRows.push({
                            description: `${group.product} ${group.variant}`,
                            priority: 2,
                            location: row.location,
                            qty: row.qty,
                            rsrvQty: row.rsrvQty,
                            percentReserved: row.percentReserved
                        });
                    });
                    
                    // Check if any Priority 2 meets threshold
                    const hasP2MeetingThreshold = priority2Rows.some(r => 
                        r.percentReserved >= reservedPercentageMin && r.percentReserved <= 100
                    );
                    
                    if (!hasP2MeetingThreshold) {
                        // Add productRows to reportData and move to next product
                        // Calculate totals for this product
                        const totalQty = productRows.reduce((sum, r) => sum + r.qty, 0);
                        const totalRsrvQty = productRows.reduce((sum, r) => sum + r.rsrvQty, 0);
                        
                        // Mark the last row with totals and blank descriptions after first row
                        productRows.forEach((row, idx) => {
                            reportData.push({
                                ...row,
                                sortKey: row.description, // Keep for sorting
                                description: idx === 0 ? row.description : '',
                                totalQty: idx === productRows.length - 1 ? totalQty : null,
                                totalRsrvQty: idx === productRows.length - 1 ? totalRsrvQty : null
                            });
                        });
                        return; // Stop here, don't show P3+
                    }
                    
                    // If P2 meets threshold, add P3, and continue cascading
                    let currentPriority = 3;
                    let keepChecking = true;
                    
                    while (keepChecking) {
                        const currentRows = group.rows.filter(r => r.priorities.includes(currentPriority));
                        
                        if (currentRows.length === 0) {
                            keepChecking = false; // No more priorities
                            break;
                        }
                        
                        // Add current priority rows
                        currentRows.forEach(row => {
                            productRows.push({
                                description: `${group.product} ${group.variant}`,
                                priority: currentPriority,
                                location: row.location,
                                qty: row.qty,
                                rsrvQty: row.rsrvQty,
                                percentReserved: row.percentReserved
                            });
                        });
                        
                        // Check if current priority meets threshold
                        const currentMeetsThreshold = currentRows.some(r => 
                            r.percentReserved >= reservedPercentageMin && r.percentReserved <= 100
                        );
                        
                        if (!currentMeetsThreshold) {
                            keepChecking = false; // Stop cascading
                        } else {
                            currentPriority++; // Check next priority
                        }
                    }
                    
                    // Calculate totals for this product
                    const totalQty = productRows.reduce((sum, r) => sum + r.qty, 0);
                    const totalRsrvQty = productRows.reduce((sum, r) => sum + r.rsrvQty, 0);
                    
                    // Add rows with totals on last row and blank descriptions after first row
                    productRows.forEach((row, idx) => {
                        reportData.push({
                            ...row,
                            sortKey: row.description, // Keep for sorting
                            description: idx === 0 ? row.description : '',
                            totalQty: idx === productRows.length - 1 ? totalQty : null,
                            totalRsrvQty: idx === productRows.length - 1 ? totalRsrvQty : null
                        });
                    });
                });
                
                // Sort by sortKey (preserves grouping with blank descriptions)
                reportData.sort((a, b) => a.sortKey.localeCompare(b.sortKey));
                
                return reportData;
            };



            const normalizeSalesRep = (name) => {
                if (!name || name.trim() === '') return 'UNKNOWN';
                
                const normalized = name.trim().toLowerCase();
                
                // JB variations (JB, Jb, JB mAY, John May, etc.)
                if (normalized === 'jb' || 
                    normalized === 'jb may' || 
                    normalized === 'john may' ||
                    normalized.startsWith('jb ')) {
                    return 'JB (John May)';
                }
                
                // Richard variations (Richard, Richard May)
                if (normalized === 'richard' || normalized === 'richard may') {
                    return 'Richard May';
                }
                
                // Jenni variations (Jenni, Jenni Briggs)
                if (normalized === 'jenni' || normalized === 'jenni briggs') {
                    return 'Jenni Briggs';
                }
                
                // Return original name if no match (with proper casing)
                return name.trim();
            };

            const getCustomerSalesSummary = (useRepGrouping = false) => {
                const groupingKey = useRepGrouping ? 'Sales Rep' : 'Customer';
                const customerMap = {};
                
                customerSalesData.forEach(row => {
                    let groupValue = (row[groupingKey] || '').trim();
                    
                    if (useRepGrouping) {
                        groupValue = normalizeSalesRep(groupValue);
                    }
                    
                    if (!groupValue && !useRepGrouping) return;
                    
                    const extendedPrice = parseNumeric(row['Extended Price'] || row['Extended price'] || '');
                    const creditsIssued = parseNumeric(row['Total Credits Issued'] || row['Total credits issued'] || '');
                    const unitPrice = parseNumeric(row['Unit Price'] || row['Unit price'] || '');
                    const fulfilled = parseNumeric(row['Fulfilled'] || '');
                    const fulfilledSale = unitPrice * fulfilled;
                    
                    if (!customerMap[groupValue]) {
                        customerMap[groupValue] = {
                            customer: groupValue,
                            extendedPrice: 0,
                            creditsIssued: 0,
                            fulfilledSale: 0
                        };
                    }
                    
                    customerMap[groupValue].extendedPrice += extendedPrice;
                    customerMap[groupValue].creditsIssued += creditsIssued;
                    customerMap[groupValue].fulfilledSale += fulfilledSale;
                });
                
                let customerArray = Object.values(customerMap).map(item => ({
                    ...item,
                    totalSold: item.extendedPrice - item.creditsIssued,
                    fulfilledSaleAfterCredits: item.fulfilledSale - item.creditsIssued
                }));
                
                const grandTotalExtended = customerArray.reduce((sum, c) => sum + c.extendedPrice, 0);
                const grandTotalCredits = customerArray.reduce((sum, c) => sum + c.creditsIssued, 0);
                const grandTotalSold = customerArray.reduce((sum, c) => sum + c.totalSold, 0);
                const grandTotalFulfilledSale = customerArray.reduce((sum, c) => sum + c.fulfilledSale, 0);
                const grandTotalFulfilledSaleAfterCredits = customerArray.reduce((sum, c) => sum + c.fulfilledSaleAfterCredits, 0);
                
                customerArray = customerArray.map(item => ({
                    ...item,
                    percentOfTotal: grandTotalFulfilledSaleAfterCredits > 0 ? (item.fulfilledSaleAfterCredits / grandTotalFulfilledSaleAfterCredits) * 100 : 0
                }));
                
                if (sortCustomerByPrice) {
                    customerArray.sort((a, b) => b.fulfilledSaleAfterCredits - a.fulfilledSaleAfterCredits);
                } else {
                    customerArray.sort((a, b) => a.customer.localeCompare(b.customer));
                }
                
                return {
                    customers: customerArray,
                    grandTotals: {
                        extendedPrice: grandTotalExtended,
                        creditsIssued: grandTotalCredits,
                        totalSold: grandTotalSold,
                        fulfilledSale: grandTotalFulfilledSale,
                        fulfilledSaleAfterCredits: grandTotalFulfilledSaleAfterCredits
                    }
                };
            };

            const getEmptySalesRepItems = () => {
                const groupedItems = {};
                
                customerSalesData.forEach(row => {
                    const salesRep = (row['Sales Rep'] || '').trim();
                    
                    if (!salesRep || salesRep === '') {
                        const orderId = (row['Order ID'] || row['Order Id'] || '').trim();
                        const customer = (row['Customer'] || '').trim();
                        const extendedPrice = parseNumeric(row['Extended Price'] || row['Extended price'] || '');
                        const creditsIssued = parseNumeric(row['Total Credits Issued'] || row['Total credits issued'] || '');
                        
                        // Create a unique key for Order ID + Customer combination
                        const key = `${orderId}::${customer}`;
                        
                        if (!groupedItems[key]) {
                            groupedItems[key] = {
                                orderId: orderId,
                                customer: customer,
                                extendedPrice: 0,
                                creditsIssued: 0,
                                totalSold: 0
                            };
                        }
                        
                        // Sum the quantities
                        groupedItems[key].extendedPrice += extendedPrice;
                        groupedItems[key].creditsIssued += creditsIssued;
                    }
                });
                
                // Convert to array and calculate totalSold for each grouped item
                const emptyItems = Object.values(groupedItems).map(item => ({
                    ...item,
                    totalSold: item.extendedPrice - item.creditsIssued
                }));
                
                // Sort by Order ID
                emptyItems.sort((a, b) => a.orderId.localeCompare(b.orderId));
                
                return emptyItems;
            };

            const getShiftsReport = () => {
                const shiftsArray = [];
                
                // Process Shipped Data (customerSalesData) - look for "shift" in Customer
                // Each customer gets its own row
                customerSalesData.forEach((row) => {
                    const product = (row['Product'] || '').trim();
                    const variant = (row['Variant'] || '').trim();
                    const customer = (row['Customer'] || '').trim();
                    const confirmed = parseNumeric(row['Confirmed'] || '');
                    const allocated = parseNumeric(row['Allocated'] || '');
                    
                    if (!product || !variant) return;
                    
                    // Check if customer contains "shift", "shifts", or "Shift" (case-insensitive)
                    const containsShift = customer.toLowerCase().includes('shift');
                    
                    if (containsShift) {
                        shiftsArray.push({
                            product: product,
                            variant: variant,
                            productVariant: `${product} ${variant}`,
                            customer: customer,
                            location: '',
                            confirmed: confirmed,
                            allocated: allocated,
                            withheldNotes: '',
                            withheldQty: 0,
                            futureShiftQty: allocated
                        });
                    }
                });
                
                // Process Inventory Data - look for Withheld notes or Withheld qty > 0
                // Each location with withheld qty gets its own row
                data.forEach((row) => {
                    const product = (row['Product'] || '').trim();
                    const variant = (row['Variant'] || '').trim();
                    const withheldNotes = (row['Withheld Notes'] || row['Withheld notes'] || '').trim();
                    const withheldQty = parseNumeric(row['Withheld qty'] || row['Withheld Qty'] || '');
                    const location = (row['Locations'] || '').trim();
                    
                    if (!product || !variant) return;
                    
                    // Include if withheld notes has content OR withheld qty > 0
                    if (withheldNotes || withheldQty > 0) {
                        // Extract core location (text after last >)
                        const coreLocation = location.lastIndexOf('>') > -1 
                            ? location.substring(location.lastIndexOf('>') + 1).trim() 
                            : location;
                        
                        shiftsArray.push({
                            product: product,
                            variant: variant,
                            productVariant: `${product} ${variant}`,
                            customer: '',
                            location: coreLocation,
                            confirmed: 0,
                            allocated: 0,
                            withheldNotes: withheldNotes,
                            withheldQty: withheldQty,
                            futureShiftQty: withheldQty
                        });
                    }
                });
                
                // Sort alphabetically by product+variant, then by customer, then by location
                shiftsArray.sort((a, b) => {
                    const keyA = `${a.product} ${a.variant}`;
                    const keyB = `${b.product} ${b.variant}`;
                    if (keyA !== keyB) return keyA.localeCompare(keyB);
                    
                    // If same product/variant, sort by customer then location
                    if (a.customer !== b.customer) return a.customer.localeCompare(b.customer);
                    return a.location.localeCompare(b.location);
                });
                
                return shiftsArray;
            };

            const getProductionPlanningReport = () => {
                // Group by Product + Variant
                const grouped = {};
                const currentYear = new Date().getFullYear();
                const years = [currentYear, currentYear + 1, currentYear + 2];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                
                // First pass: process production items data
                data.forEach(row => {
                    const product = (row['Product'] || '').trim();
                    const variant = (row['Variant'] || '').trim();
                    const qty = parseNumeric(row['Qty']);
                    const status = (row['Status'] || '').trim();
                    const withheldQty = parseNumeric(row['Withheld qty'] || row['Withheld Qty'] || '');
                    const readyDate = row['Ready date'] || row['Ready Date'] || '';
                    const startDate = row['Start date'] || row['Start Date'] || '';
                    
                    if (!product || !variant || qty === 0) return;
                    
                    const key = `${product}::${variant}`;
                    
                    if (!grouped[key]) {
                        const variantBase = variant.split('|')[0].trim();
                        const size = getVariantSize(variant);
                        const shippedKey = `${product}|${variantBase}|${size}`;
                        
                        grouped[key] = {
                            description: `${product} ${variant}`,
                            product: product,
                            variant: variant,
                            totalQty: 0,
                            inProductionQty: 0,
                            readyQty: 0,
                            shippedYTD: shippedData[shippedKey] || 0,
                            futureShiftQty: 0,
                            withheldQtyTotal: 0,
                            projectedQty: 0  // Will be calculated later from past 3 years sales
                        };
                        
                        // Initialize Ready Date columns - 3 years
                        years.forEach(year => {
                            months.forEach(month => {
                                grouped[key][`ready${month}${year}`] = 0;
                            });
                            seasons.forEach(season => {
                                grouped[key][`ready${season}${year}`] = 0;
                            });
                        });
                        
                        // Initialize Start Date columns - 3 years
                        years.forEach(year => {
                            months.forEach(month => {
                                grouped[key][`start${month}${year}`] = 0;
                            });
                            seasons.forEach(season => {
                                grouped[key][`start${season}${year}`] = 0;
                            });
                        });
                    }
                    
                    // Add to total
                    grouped[key].totalQty += qty;
                    
                    // Add withheld qty
                    grouped[key].withheldQtyTotal += withheldQty;
                    
                    // Check status and add to appropriate category
                    const statusLower = status.toLowerCase();
                    if (statusLower.includes('production')) {
                        grouped[key].inProductionQty += qty;
                        
                        // Parse ready date and add to month/season columns (for In Production items)
                        if (readyDate) {
                            const date = new Date(readyDate);
                            if (!isNaN(date.getTime())) {
                                const year = date.getFullYear();
                                const month = date.getMonth(); // 0-11
                                const monthName = months[month];
                                const monthKey = `ready${monthName}${year}`;
                                if (grouped[key][monthKey] !== undefined) {
                                    grouped[key][monthKey] += qty;
                                }
                                
                                // Determine season
                                let seasonName;
                                if (month === 11 || month === 0 || month === 1) seasonName = 'Winter';
                                else if (month >= 2 && month <= 4) seasonName = 'Spring';
                                else if (month >= 5 && month <= 7) seasonName = 'Summer';
                                else seasonName = 'Fall';
                                
                                const seasonKey = `ready${seasonName}${year}`;
                                if (grouped[key][seasonKey] !== undefined) {
                                    grouped[key][seasonKey] += qty;
                                }
                            }
                        }
                    } else if (statusLower === 'ready') {
                        grouped[key].readyQty += qty;
                    }
                    
                    // Parse start date and add to month/season columns (for all items)
                    if (startDate) {
                        const date = new Date(startDate);
                        if (!isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            const month = date.getMonth(); // 0-11
                            const monthName = months[month];
                            const monthKey = `start${monthName}${year}`;
                            if (grouped[key][monthKey] !== undefined) {
                                grouped[key][monthKey] += qty;
                            }
                            
                            // Determine season
                            let seasonName;
                            if (month === 11 || month === 0 || month === 1) seasonName = 'Winter';
                            else if (month >= 2 && month <= 4) seasonName = 'Spring';
                            else if (month >= 5 && month <= 7) seasonName = 'Summer';
                            else seasonName = 'Fall';
                            
                            const seasonKey = `start${seasonName}${year}`;
                            if (grouped[key][seasonKey] !== undefined) {
                                grouped[key][seasonKey] += qty;
                            }
                        }
                    }
                });
                
                // Second pass: calculate Future Shift Qty from customerSalesData
                customerSalesData.forEach(row => {
                    const product = (row['Product'] || '').trim();
                    const variant = (row['Variant'] || '').trim();
                    const customer = (row['Customer'] || '').trim();
                    const allocated = parseNumeric(row['Allocated'] || '');
                    
                    if (!product || !variant) return;
                    
                    const key = `${product}::${variant}`;
                    
                    // If this product-variant exists in our grouped data
                    if (grouped[key]) {
                        // Check if customer contains "shift"
                        const containsShift = customer.toLowerCase().includes('shift');
                        
                        if (containsShift) {
                            grouped[key].futureShiftQty += allocated;
                        }
                    }
                });
                
                // Add withheld qty to future shift qty
                Object.keys(grouped).forEach(key => {
                    grouped[key].futureShiftQty += grouped[key].withheldQtyTotal;
                });
                
                // Third pass: Add fulfilled sales data by year
                // First, detect all "Sold YYYY" columns (case-insensitive)
                const soldYearColumns = [];
                if (fulfilledSalesData.length > 0) {
                    Object.keys(fulfilledSalesData[0]).forEach(col => {
                        // Match "Sold YYYY" case-insensitively
                        if (col.match(/^Sold \d{4}$/i)) {
                            soldYearColumns.push(col);
                        }
                    });
                    soldYearColumns.sort(); // Sort chronologically
                    
                    // Initialize year columns in grouped data
                    Object.keys(grouped).forEach(key => {
                        soldYearColumns.forEach(yearCol => {
                            grouped[key][yearCol] = 0;
                        });
                    });
                    
                    // Build SKU lookup from production items data
                    const skuToKey = {};
                    data.forEach(row => {
                        const product = (row['Product'] || '').trim();
                        const variant = (row['Variant'] || '').trim();
                        const sku = (row['SKU'] || row['Sku'] || '').trim();
                        
                        if (product && variant && sku) {
                            const key = `${product}::${variant}`;
                            skuToKey[sku] = key;
                        }
                    });
                    
                    // Match fulfilled sales to production items by SKU
                    fulfilledSalesData.forEach(salesRow => {
                        const sku = (salesRow['SKU#'] || salesRow['SKU'] || salesRow['sku'] || '').trim();
                        
                        if (!sku) return;
                        
                        // Find matching key by SKU
                        const key = skuToKey[sku];
                        
                        if (key && grouped[key]) {
                            // Add all year data
                            soldYearColumns.forEach(yearCol => {
                                const yearValue = parseNumeric(salesRow[yearCol] || '');
                                grouped[key][yearCol] += yearValue;
                            });
                        }
                    });
                }
                
                // Calculate year averages for each item
    if (soldYearColumns.length > 0) {

        const currentYear = new Date().getFullYear();

        const recentYears = soldYearColumns
            .filter(col => parseInt(col.replace("Sold ", "")) < currentYear)
            .slice(-yearAverageCount);

        const past3Completed = soldYearColumns
            .filter(col => parseInt(col.replace("Sold ", "")) < currentYear)
            .slice(-3);

        Object.keys(grouped).forEach(key => {

            let sum = 0;
            let count = 0;

            recentYears.forEach(yearCol => {
                const value = grouped[key][yearCol] || 0;
                sum += value;
                count++;
            });

            grouped[key].yearAverage = count > 0 ? Math.round(sum / count) : 0;

            let projectedSum = 0;
            past3Completed.forEach(yearCol => {
                projectedSum += grouped[key][yearCol] || 0;
            });

            grouped[key].projectedQty = projectedSum;
        });
    }
                    });
                }
                
                // Convert to array and sort alphabetically by description
                const reportArray = Object.values(grouped);
                reportArray.sort((a, b) => a.description.localeCompare(b.description));
                
                // Attach soldYearColumns for use in rendering
                reportArray.soldYearColumns = soldYearColumns;
                
                return reportArray;
            };

            const exportCustomerSalesToExcel = () => {
                const wb = XLSX.utils.book_new();
                const summary = getCustomerSalesSummary(false);
                
                const wsData = [['Customer', 'Fulfilled Sale', 'Total Credits Issued', 'Fulfilled Sale After Credits', '% of Total']];
                summary.customers.forEach(customer => {
                    wsData.push([
                        customer.customer,
                        parseFloat(customer.fulfilledSale.toFixed(2)),
                        parseFloat(customer.creditsIssued.toFixed(2)),
                        parseFloat(customer.fulfilledSaleAfterCredits.toFixed(2)),
                        parseFloat(customer.percentOfTotal.toFixed(2))
                    ]);
                });
                
                wsData.push([
                    'GRAND TOTAL',
                    parseFloat(summary.grandTotals.fulfilledSale.toFixed(2)),
                    parseFloat(summary.grandTotals.creditsIssued.toFixed(2)),
                    parseFloat(summary.grandTotals.fulfilledSaleAfterCredits.toFixed(2)),
                    100.00
                ]);
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                ws['!cols'] = [
                    { wch: 40 },
                    { wch: 18 },
                    { wch: 22 },
                    { wch: 25 },
                    { wch: 12 }
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, "Sales Summary");
                const sortType = sortCustomerByPrice ? 'ByTotalSold' : 'Alphabetical';
                XLSX.writeFile(wb, `Customer_Sales_Summary_${sortType}_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const exportToPDF = () => {
                window.print();
            };

            const exportToWord = () => {
                // Create a simple HTML document structure for Word
                let htmlContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset='utf-8'>
                        <title>Inventory Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                            th, td { border: 1px solid black; padding: 8px; text-align: left; }
                            th { background-color: #f0f0f0; font-weight: bold; }
                            h1 { color: #333; margin-bottom: 10px; }
                            h2 { color: #333; margin-top: 20px; margin-bottom: 10px; }
                        </style>
                    </head>
                    <body>
                        <h1>May Nursery - Inventory Report</h1>
                        <p>Generated: ${getCurrentDateFormatted()}</p>
                `;

                const sortedPlantBlocks = Object.keys(filteredGroupedData).sort();
                
                sortedPlantBlocks.forEach((plantBlock) => {
                    const variants = filteredGroupedData[plantBlock];
                    const sortedVariants = sortVariantsBySize(variants);
                    
                    htmlContent += `<h2>${plantBlock}</h2>`;
                    htmlContent += `<table>
                        <thead>
                            <tr>
                                <th>Plant Name</th>
                                <th>Status</th>
                                <th>Pull Priority</th>
                                <th>Locations</th>
                                <th>Ready Date</th>
                                <th>Qty</th>
                                <th>Rsrv Qty</th>
                                <th>Avail Qty</th>
                                <th>${Object.keys(shippedData).length > 0 ? 'Shipped YTD' : 'Pull Qty'}</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    let lastSize = null;
                    Object.entries(sortedVariants).forEach(([variantKey, rows]) => {
                        rows.forEach(row => {
                            const currentSize = extractContainerSize(row.plantName);
                            const isFirstOfSize = currentSize !== lastSize;
                            lastSize = currentSize;
                            
                            const lastColumn = Object.keys(shippedData).length > 0 
                                ? (isFirstOfSize ? row.shippedYTD : '') 
                                : row.pullQty;
                            
                            htmlContent += `<tr>
                                <td>${row.plantName}</td>
                                <td>${row.status}</td>
                                <td>${row.pullPriority}</td>
                                <td>${row.locations}</td>
                                <td>${row.readyDate}</td>
                                <td>${row.qty}</td>
                                <td>${row.rsrvQty}</td>
                                <td>${row.availQty}</td>
                                <td>${lastColumn}</td>
                            </tr>`;
                        });
                    });
                    
                    htmlContent += `</tbody></table>`;
                });

                htmlContent += `</body></html>`;

                // Create blob and download
                const blob = new Blob(['\ufeff', htmlContent], {
                    type: 'application/msword'
                });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Inventory_Report_${new Date().toISOString().split('T')[0]}.doc`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const filteredGroupedData = getFilteredData();

            const hasPriority1 = (priority) => {
                return priority.split(',').map(p => p.trim()).includes('1');
            };

            const shouldBold = (row) => {
                const originalStatus = (row.originalStatus || '').toLowerCase();
                const isInProduction = originalStatus.includes('production');
                
                return hasPriority1(row.pullPriority) && 
                       !isInProduction && 
                       row.availQty > 0;
            };

            const exportToTSV = async () => {
                const tsvRows = [];
                
                const sortedPlantBlocks = Object.keys(filteredGroupedData).sort();
                
                sortedPlantBlocks.forEach((plantBlock) => {
                    const variants = filteredGroupedData[plantBlock];
                    const sortedVariants = sortVariantsBySize(variants);
                    
                    const headerName = Object.keys(shippedData).length > 0 ? 'Shipped YTD' : 'Pull qty';
                    tsvRows.push(`${plantBlock}\tStatus\tPull priorty\tLocations\tReady date\tQty\tRsrv qty\tAvail qty\t${headerName}`);
                    
                    let lastSize = null;
                    Object.entries(sortedVariants).forEach(([variantKey, rows]) => {
                        rows.forEach(row => {
                            const currentSize = extractContainerSize(row.plantName);
                            const isFirstOfSize = currentSize !== lastSize;
                            lastSize = currentSize;
                            
                            const lastColumn = Object.keys(shippedData).length > 0 
                                ? (isFirstOfSize ? row.shippedYTD : '') 
                                : row.pullQty;
                            tsvRows.push(
                                `${row.plantName}\t${row.status}\t${row.pullPriority}\t${row.locations}\t${row.readyDate}\t${row.qty}\t${row.rsrvQty}\t${row.availQty}\t${lastColumn}`
                            );
                        });
                    });
                    
                    tsvRows.push('');
                });
                
                const tsvContent = tsvRows.join('\n');
                
                try {
                    await navigator.clipboard.writeText(tsvContent);
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 3000);
                } catch (err) {
                    alert('Failed to copy to clipboard. Please try again.');
                }
            };

            const exportToExcel = () => {
                const wb = XLSX.utils.book_new();
                const wsData = [];
                const boldRows = [];

                const sortedPlantBlocks = Object.keys(filteredGroupedData).sort();
                
                sortedPlantBlocks.forEach((plantBlock) => {
                    const variants = filteredGroupedData[plantBlock];
                    const sortedVariants = sortVariantsBySize(variants);
                    
                    const headerName = Object.keys(shippedData).length > 0 ? 'Shipped YTD' : 'Pull qty';
                    const headers = [plantBlock, 'Status', 'Pull priorty', 'Locations', 'Ready date', 'Qty', 'Rsrv qty', 'Avail qty', headerName];
                    wsData.push(headers);
                    boldRows.push(wsData.length - 1);
                    
                    let lastSize = null;
                    Object.entries(sortedVariants).forEach(([variantKey, rows]) => {
                        rows.forEach(row => {
                            const currentSize = extractContainerSize(row.plantName);
                            const isFirstOfSize = currentSize !== lastSize;
                            lastSize = currentSize;
                            
                            const lastColumn = Object.keys(shippedData).length > 0 
                                ? (isFirstOfSize ? row.shippedYTD : '') 
                                : row.pullQty;
                            const dataRow = [
                                row.plantName,
                                row.status,
                                row.pullPriority,
                                row.locations,
                                row.readyDate,
                                row.qty,
                                row.rsrvQty,
                                row.availQty,
                                lastColumn
                            ];
                            wsData.push(dataRow);
                            
                            if (shouldBold(row)) {
                                boldRows.push(wsData.length - 1);
                            }
                        });
                    });
                    
                    wsData.push([]);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);

                ws['!cols'] = [
                    { wch: 25 },
                    { wch: 10 },
                    { wch: 12 },
                    { wch: 20 },
                    { wch: 12 },
                    { wch: 8 },
                    { wch: 10 },
                    { wch: 10 },
                    { wch: 12 }
                ];

                boldRows.forEach(rowIdx => {
                    for (let col = 0; col < 9; col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: rowIdx, c: col });
                        if (!ws[cellRef]) ws[cellRef] = { t: 's', v: '' };
                        ws[cellRef].s = {
                            font: { bold: true }
                        };
                    }
                });

                XLSX.utils.book_append_sheet(wb, ws, "Inventory Report");
                XLSX.writeFile(wb, `Inventory_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const exportTotalCanQtyToExcel = () => {
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: All Statuses
                const allData = [['Container Size', 'Total Quantity']];
                getSizeSummary().forEach(([size, qty]) => {
                    allData.push([size, qty]);
                });
                allData.push(['TOTAL', getSizeSummary().reduce((sum, [, qty]) => sum + qty, 0)]);
                const ws1 = XLSX.utils.aoa_to_sheet(allData);
                ws1['!cols'] = [{ wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws1, "All Statuses");
                
                // Sheet 2: In Production
                const prodData = [['Container Size', 'Total Quantity']];
                getSizeByStatus('In production').forEach(([size, qty]) => {
                    prodData.push([size, qty]);
                });
                prodData.push(['TOTAL', getSizeByStatus('In production').reduce((sum, [, qty]) => sum + qty, 0)]);
                const ws2 = XLSX.utils.aoa_to_sheet(prodData);
                ws2['!cols'] = [{ wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws2, "In Production");
                
                // Sheet 3: Ready
                const readyData = [['Container Size', 'Total Quantity']];
                getSizeByStatus('Ready').forEach(([size, qty]) => {
                    readyData.push([size, qty]);
                });
                readyData.push(['TOTAL', getSizeByStatus('Ready').reduce((sum, [, qty]) => sum + qty, 0)]);
                const ws3 = XLSX.utils.aoa_to_sheet(readyData);
                ws3['!cols'] = [{ wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws3, "Ready");
                
                // Sheet 4: Planned
                const plannedData = [['Container Size', 'Total Quantity']];
                getSizeByStatus('Planned').forEach(([size, qty]) => {
                    plannedData.push([size, qty]);
                });
                plannedData.push(['TOTAL', getSizeByStatus('Planned').reduce((sum, [, qty]) => sum + qty, 0)]);
                const ws4 = XLSX.utils.aoa_to_sheet(plannedData);
                ws4['!cols'] = [{ wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws4, "Planned");
                
                XLSX.writeFile(wb, `Total_Can_Quantity_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const exportReservedToExcel = () => {
                const wb = XLSX.utils.book_new();
                const reportData = getReservedInventoryReport();
                
                const wsData = [['Description', 'Pull priority', 'Location', 'Qty', 'Rsrv Qty', '% Reserved', 'Total Qty', 'Total Rsrv Qty']];
                reportData.forEach(row => {
                    wsData.push([
                        row.description,
                        row.priority,
                        row.location,
                        row.qty,
                        row.rsrvQty,
                        parseFloat(row.percentReserved.toFixed(1)),
                        row.totalQty !== null ? row.totalQty : '',
                        row.totalRsrvQty !== null ? row.totalRsrvQty : ''
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                ws['!cols'] = [
                    { wch: 40 },
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 10 },
                    { wch: 10 },
                    { wch: 12 },
                    { wch: 12 },
                    { wch: 14 }
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, "Reserved Inventory");
                XLSX.writeFile(wb, `Reserved_Inventory_${reservedPercentageMin}to100_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const exportShiftsReportToExcel = () => {
                const wb = XLSX.utils.book_new();
                const reportData = getShiftsReport();
                
                const wsData = [['Product Variant', 'Customer', 'Location', 'Confirmed Qty', 'Allocated', 'Withheld Notes', 'Withheld Qty', 'Future Shift Qty']];
                reportData.forEach(row => {
                    wsData.push([
                        row.productVariant,
                        row.customer,
                        row.location,
                        row.confirmed,
                        row.allocated,
                        row.withheldNotes,
                        row.withheldQty,
                        row.futureShiftQty
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                ws['!cols'] = [
                    { wch: 40 },  // Product Variant
                    { wch: 30 },  // Customer
                    { wch: 15 },  // Location
                    { wch: 12 },  // Confirmed
                    { wch: 12 },  // Allocated
                    { wch: 40 },  // Withheld Notes
                    { wch: 12 },  // Withheld Qty
                    { wch: 15 }   // Future Shift Qty
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, "Shifts Report");
                XLSX.writeFile(wb, `Shifts_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const exportProductionPlanningToExcel = () => {
                const wb = XLSX.utils.book_new();
                const reportData = getProductionPlanningReport();
                const yearCols = reportData.soldYearColumns || [];
                
                // Filter visible year columns
                const visibleYears = yearCols.filter(col => visibleYearColumns.has(col));
                
                // Build header row with base columns (conditionally), average, and visible year columns
                const headerRow = ['Description', 'Total Qty'];
                const colWidths = [
                    { wch: 50 },  // Description
                    { wch: 15 }   // Total Qty
                ];
                
                // Add conditional main columns
                if (showInProductionQty) {
                    headerRow.push('In Production Qty');
                    colWidths.push({ wch: 18 });
                }
                if (showReadyQty) {
                    headerRow.push('Ready Qty');
                    colWidths.push({ wch: 15 });
                }
                if (showShippedYTD) {
                    headerRow.push('Shipped YTD');
                    colWidths.push({ wch: 15 });
                }
                if (showFutureShiftQty) {
                    headerRow.push('Future Shift Qty');
                    colWidths.push({ wch: 18 });
                }
                
                // Add year average column
                if (yearCols.length > 0) {
                    headerRow.push(`Past ${yearAverageCount}-Year Avg`);
                    colWidths.push({ wch: 18 });
                    
                    // Add Projected Qty column
                    if (showProjectedQty) {
                        headerRow.push('Projected Qty');
                        colWidths.push({ wch: 18 });
                    }
                }
                
                // Add visible year columns
                headerRow.push(...visibleYears);
                visibleYears.forEach(() => {
                    colWidths.push({ wch: 15 });
                });
                
                // Add Ready date month columns if enabled
                if (showReadyMonthColumns) {
                    const currentYear = new Date().getFullYear();
                    const years = [currentYear, currentYear + 1, currentYear + 2];
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    
                    years.forEach(year => {
                        months.forEach(month => {
                            const key = `${month} ${year}`;
                            if (visibleReadyMonths.has(key)) {
                                headerRow.push(`Ready ${month} ${year}`);
                                colWidths.push({ wch: 16 });
                            }
                        });
                    });
                }
                
                // Add Ready date season columns if enabled
                if (showReadySeasonColumns) {
                    const currentYear = new Date().getFullYear();
                    const years = [currentYear, currentYear + 1, currentYear + 2];
                    const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                    
                    years.forEach(year => {
                        seasons.forEach(season => {
                            const key = `${season} ${year}`;
                            if (visibleReadySeasons.has(key)) {
                                headerRow.push(`Ready ${season} ${year}`);
                                colWidths.push({ wch: 18 });
                            }
                        });
                    });
                }
                
                // Add Start date month columns if enabled
                if (showStartMonthColumns) {
                    const currentYear = new Date().getFullYear();
                    const years = [currentYear, currentYear + 1, currentYear + 2];
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    
                    years.forEach(year => {
                        months.forEach(month => {
                            const key = `${month} ${year}`;
                            if (visibleStartMonths.has(key)) {
                                headerRow.push(`${month} ${year}`);
                                colWidths.push({ wch: 14 });
                            }
                        });
                    });
                }
                
                // Add Start date season columns if enabled
                if (showStartSeasonColumns) {
                    const currentYear = new Date().getFullYear();
                    const years = [currentYear, currentYear + 1, currentYear + 2];
                    const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                    
                    years.forEach(year => {
                        seasons.forEach(season => {
                            const key = `${season} ${year}`;
                            if (visibleStartSeasons.has(key)) {
                                headerRow.push(`${season} ${year}`);
                                colWidths.push({ wch: 16 });
                            }
                        });
                    });
                }
                
                const wsData = [headerRow];
                
                reportData.forEach(row => {
                    const rowData = [
                        row.description,
                        row.totalQty
                    ];
                    
                    // Add conditional main columns
                    if (showInProductionQty) rowData.push(row.inProductionQty);
                    if (showReadyQty) rowData.push(row.readyQty);
                    if (showShippedYTD) rowData.push(row.shippedYTD);
                    if (showFutureShiftQty) rowData.push(row.futureShiftQty);
                    
                    // Add average column
                    if (yearCols.length > 0) {
                        rowData.push(row.yearAverage || 0);
                        
                        // Add Projected Qty column
                        if (showProjectedQty) {
                            rowData.push(row.projectedQty || 0);
                        }
                    }
                    
                    // Add visible year columns
                    visibleYears.forEach(yearCol => {
                        rowData.push(row[yearCol] || 0);
                    });
                    
                    // Add Ready date month columns if enabled
                    if (showReadyMonthColumns) {
                        const currentYear = new Date().getFullYear();
                        const years = [currentYear, currentYear + 1, currentYear + 2];
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        
                        years.forEach(year => {
                            months.forEach(month => {
                                const key = `${month} ${year}`;
                                if (visibleReadyMonths.has(key)) {
                                    rowData.push(row[`ready${month}${year}`] || 0);
                                }
                            });
                        });
                    }
                    
                    // Add Ready date season columns if enabled
                    if (showReadySeasonColumns) {
                        const currentYear = new Date().getFullYear();
                        const years = [currentYear, currentYear + 1, currentYear + 2];
                        const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                        
                        years.forEach(year => {
                            seasons.forEach(season => {
                                const key = `${season} ${year}`;
                                if (visibleReadySeasons.has(key)) {
                                    rowData.push(row[`ready${season}${year}`] || 0);
                                }
                            });
                        });
                    }
                    
                    // Add Start date month columns if enabled
                    if (showStartMonthColumns) {
                        const currentYear = new Date().getFullYear();
                        const years = [currentYear, currentYear + 1, currentYear + 2];
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        
                        years.forEach(year => {
                            months.forEach(month => {
                                const key = `${month} ${year}`;
                                if (visibleStartMonths.has(key)) {
                                    rowData.push(row[`start${month}${year}`] || 0);
                                }
                            });
                        });
                    }
                    
                    // Add Start date season columns if enabled
                    if (showStartSeasonColumns) {
                        const currentYear = new Date().getFullYear();
                        const years = [currentYear, currentYear + 1, currentYear + 2];
                        const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                        
                        years.forEach(year => {
                            seasons.forEach(season => {
                                const key = `${season} ${year}`;
                                if (visibleStartSeasons.has(key)) {
                                    rowData.push(row[`start${season}${year}`] || 0);
                                }
                            });
                        });
                    }
                    
                    wsData.push(rowData);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, "Production Planning");
                XLSX.writeFile(wb, `Production_Planning_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const Upload = () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
            );

            const Download = () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            );

            const ExcelIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
            );

            const SearchIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            );

            const PdfIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <path d="M9 15h6"></path>
                    <path d="M12 18v-6"></path>
                </svg>
            );

            const WordIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <path d="M9 17V13l2 3 2-3v4"></path>
                </svg>
            );

            const ChevronDown = () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            );

            const ChevronRight = () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            );

            const getCurrentDateFormatted = () => {
                const date = new Date();
                const options = { month: 'long', day: 'numeric', year: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            };

            return (
                <div className="min-h-screen p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="access-header no-print mb-6">
                            Inventory Reports
                        </div>

                        <div className="shadow-lg p-6 mb-6 no-print" style={{background: '#00CCFF'}}>
                            <div className="mb-4">
                                <button 
                                    onClick={() => setShowInstructions(!showInstructions)}
                                    className="inline-flex items-center gap-2 px-6 py-3 access-button transition text-gray-800 font-semibold"
                                >
                                    <span> Show Instructions</span>
                                    {showInstructions ? <ChevronDown /> : <ChevronRight />}
                                </button>
                            </div>

                            {showInstructions && (
                                <>
                                    <div className="mb-4 p-4" style={{background: '#00CCFF', border: '2px solid #00A3CC'}}>
                                        <p className="font-semibold text-black mb-2">Instructions for getting your Production Items CSV file:</p>
                                        <ol className="list-decimal list-inside space-y-1 text-sm text-black">
                                            <li>Go to <span className="font-semibold">Production Items</span></li>
                                            <li>Select the view called <span className="font-semibold">"Inventory Reports"</span></li>
                                            <li>Export as CSV</li>
                                            <li>Use that downloaded CSV file with this tool</li>
                                        </ol>
                                    </div>

                                    <div className="mb-4 p-4" style={{background: '#00CCFF', border: '2px solid #00A3CC'}}>
                                        <p className="font-semibold text-black mb-2">Instructions for getting your Line Items CSV file:</p>
                                        <ol className="list-decimal list-inside space-y-1 text-sm text-black">
                                            <li>Go to <span className="font-semibold">Sales  'Line Items'  Inventory Reports</span></li>
                                            <li className="mt-2"><strong>  IMPORTANT - Set these two filters:</strong>
                                                <ul className="list-disc list-inside ml-6 mt-1 space-y-1">
                                                    <li><span className="font-semibold">Fulfilled is greater than 0</span></li>
                                                    <li><span className="font-semibold">Picking date is on or after 1/1/2025</span> (or current year)</li>
                                                </ul>
                                            </li>
                                            <li>Click the <span className="font-semibold">3 dots on the top right  'Export CSV'</span></li>
                                            <li>Wait for the prompt and select <span className="font-semibold">'Load All'</span></li>
                                            <li>When the file downloads, use it with this tool</li>
                                        </ol>
                                    </div>

                                    <div className="mb-4 p-4 bg-green-50 border-l-4 border-green-400">
                                        <p className="text-sm text-gray-700">
                                            <strong> Good to know:</strong> The order of columns in your CSV files doesn't matter! 
                                            This tool reads data by column name, so the columns can be in any order and it will still work perfectly.
                                        </p>
                                    </div>

                                    <div className="mb-4 p-4 bg-blue-50 border-l-4 border-blue-400">
                                        <p className="text-sm text-gray-700 font-semibold mb-2"> Required Column Names:</p>
                                        <p className="text-xs text-gray-600 mb-2">
                                            <strong>Case doesn't matter!</strong> The tool automatically handles uppercase, lowercase, or mixed case.
                                        </p>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-700">
                                            <div>
                                                <strong>Production Items CSV needs:</strong>
                                                <ul className="list-disc list-inside ml-2 mt-1">
                                                    <li>Product</li>
                                                    <li>Variant</li>
                                                    <li>Qty (or Quantity)</li>
                                                    <li>Status</li>
                                                    <li>Start date</li>
                                                    <li>Ready date</li>
                                                    <li>Locations (or Location)</li>
                                                    <li>Pull Priorty / Pull Priority / Priority</li>
                                                    <li>Reserved qty</li>
                                                    <li>Available qty</li>
                                                    <li>Pulled qty</li>
                                                    <li>Inventory Notes (optional)</li>
                                                </ul>
                                            </div>
                                            <div>
                                                <strong>Line Items CSV needs:</strong>
                                                <ul className="list-disc list-inside ml-2 mt-1">
                                                    <li>Product</li>
                                                    <li>Variant</li>
                                                    <li>Fulfilled</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <p className="text-xs text-gray-600 mt-2 italic">
                                            Note: Even if "Pull priorty" is fixed to "Pull priority" in the future, this tool will still work!
                                        </p>
                                    </div>
                                </>
                            )}
                            
                            <div className="flex flex-wrap gap-4 mb-6">
                                <label 
                                    className={`inline-flex items-center gap-2 px-6 py-3 access-button cursor-pointer transition text-gray-800 font-semibold ${isDraggingInventory ? 'ring-4 ring-[#00CCFF]' : ''}`}
                                    onDragOver={handleInventoryDragOver}
                                    onDragLeave={handleInventoryDragLeave}
                                    onDrop={handleInventoryDrop}
                                >
                                    <Upload />
                                    <span>Upload Production Items CSV</span>
                                    <input 
                                        type="file" 
                                        accept=".csv" 
                                        onChange={handleFileUpload}
                                        className="hidden"
                                    />
                                </label>
                                
                                <label 
                                    className={`inline-flex items-center gap-2 px-6 py-3 access-button cursor-pointer transition text-gray-800 font-semibold ${isDraggingShipped ? 'ring-4 ring-[#00CCFF]' : ''}`}
                                    onDragOver={handleShippedDragOver}
                                    onDragLeave={handleShippedDragLeave}
                                    onDrop={handleShippedDrop}
                                >
                                    <Upload />
                                    <span>Upload Line Items CSV</span>
                                    <input 
                                        type="file" 
                                        accept=".csv" 
                                        onChange={handleShippedFileUpload}
                                        className="hidden"
                                    />
                                </label>
                                
                                <label 
                                    className={`inline-flex items-center gap-2 px-6 py-3 access-button cursor-pointer transition text-gray-800 font-semibold ${isDraggingFulfilledSales ? 'ring-4 ring-[#00CCFF]' : ''}`}
                                    onDragOver={handleFulfilledSalesDragOver}
                                    onDragLeave={handleFulfilledSalesDragLeave}
                                    onDrop={handleFulfilledSalesDrop}
                                >
                                    <Upload />
                                    <span>Upload Fulfilled Sales Report (Optional)</span>
                                    <input 
                                        type="file" 
                                        accept=".xlsx,.xls" 
                                        onChange={handleFulfilledSalesFileUpload}
                                        className="hidden"
                                    />
                                </label>
                                
                                {Object.keys(groupedData).length > 0 && (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {/* PRODUCTION REPORTS */}
                                        <div className="border-2 p-4" style={{borderColor: '#0097A7', background: '#00CCFF'}}>
                                            <h3 className="text-sm font-bold mb-3 uppercase tracking-wide" style={{color: '#333'}}>Production Reports</h3>
                                            <div className="space-y-2">
                                                <button
                                                    onClick={() => {
                                                        setShowReservedReport(!showReservedReport);
                                                        setShowSizeSummary(false);
                                                        setShowCustomerSales(false);
                                                        setShowShiftsReport(false);
                                                        setShowProductionPlanning(false);
                                                    }}
                                                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                >
                                                    <span>{showReservedReport ? 'Show Full Report' : 'Reserved Report'}</span>
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        setShowSizeSummary(!showSizeSummary);
                                                        setShowReservedReport(false);
                                                        setShowCustomerSales(false);
                                                        setShowShiftsReport(false);
                                                        setShowProductionPlanning(false);
                                                    }}
                                                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                >
                                                    <span>{showSizeSummary ? 'Show Full Report' : 'Total Can Quantity Report'}</span>
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        setShowProductionPlanning(!showProductionPlanning);
                                                        setShowReservedReport(false);
                                                        setShowSizeSummary(false);
                                                        setShowCustomerSales(false);
                                                        setShowShiftsReport(false);
                                                    }}
                                                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                >
                                                    <span>{showProductionPlanning ? 'Show Full Report' : 'Production Planning Report'}</span>
                                                </button>
                                            </div>
                                        </div>

                                        {/* SALES REPORTS */}
                                        <div className="border-2 p-4" style={{borderColor: '#0097A7', background: '#00CCFF'}}>
                                            <h3 className="text-sm font-bold mb-3 uppercase tracking-wide" style={{color: '#333'}}>Sales Reports</h3>
                                            <div className="space-y-2">
                                                {customerSalesData.length > 0 ? (
                                                    <>
                                                        <button
                                                            onClick={() => {
                                                                setShowCustomerSales(!showCustomerSales);
                                                                setShowReservedReport(false);
                                                                setShowSizeSummary(false);
                                                                setShowShiftsReport(false);
                                                                setShowGroupByRep(false);
                                                                setShowMissingRep(false);
                                                                setShowProductionPlanning(false);
                                                            }}
                                                            className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                        >
                                                            <span>{showCustomerSales ? 'Show Full Report' : 'Sales by Business Report'}</span>
                                                        </button>
                                                        {Object.keys(groupedData).length > 0 && (
                                                            <button
                                                                onClick={() => {
                                                                    setShowShiftsReport(!showShiftsReport);
                                                                    setShowCustomerSales(false);
                                                                    setShowReservedReport(false);
                                                                    setShowSizeSummary(false);
                                                                    setShowGroupByRep(false);
                                                                    setShowMissingRep(false);
                                                                    setShowProductionPlanning(false);
                                                                }}
                                                                className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                            >
                                                                <span>{showShiftsReport ? 'Show Full Report' : 'Shifts Report'}</span>
                                                            </button>
                                                        )}
                                                        <button
                                                            onClick={() => {
                                                                setShowGroupByRep(!showGroupByRep);
                                                                setShowCustomerSales(false);
                                                                setShowReservedReport(false);
                                                                setShowSizeSummary(false);
                                                                setShowShiftsReport(false);
                                                                setShowMissingRep(false);
                                                                setShowProductionPlanning(false);
                                                            }}
                                                            className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                        >
                                                            <span>{showGroupByRep ? 'Show Full Report' : 'Sales by Rep Report'}</span>
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setShowMissingRep(!showMissingRep);
                                                                setShowCustomerSales(false);
                                                                setShowReservedReport(false);
                                                                setShowSizeSummary(false);
                                                                setShowShiftsReport(false);
                                                                setShowGroupByRep(false);
                                                                setShowProductionPlanning(false);
                                                            }}
                                                            className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                        >
                                                            <span>{showMissingRep ? 'Show Full Report' : 'Unknown Rep Report'}</span>
                                                        </button>
                                                    </>
                                                ) : (
                                                    <div className="text-xs text-gray-500 italic text-center py-2">
                                                        Upload Line Items CSV to enable
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* EXPORT OPTIONS */}
                                        <div className="border-2 p-4" style={{borderColor: '#0097A7', background: '#00CCFF'}}>
                                            <h3 className="text-sm font-bold mb-3 uppercase tracking-wide" style={{color: '#333'}}>Export Options</h3>
                                            <div className="space-y-2">
                                                <button
                                                    onClick={exportToTSV}
                                                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                >
                                                    <Download />
                                                    <span>{copySuccess ? 'Copied!' : 'Copy to Clipboard'}</span>
                                                </button>
                                                <button
                                                    onClick={exportToExcel}
                                                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                >
                                                    <ExcelIcon />
                                                    <span>Export to Excel</span>
                                                </button>
                                                <button
                                                    onClick={exportToPDF}
                                                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                >
                                                    <PdfIcon />
                                                    <span>Export to PDF</span>
                                                </button>
                                                <button
                                                    onClick={exportToWord}
                                                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 access-button transition text-gray-800 font-semibold text-sm"
                                                >
                                                    <WordIcon />
                                                    <span>Export to Word</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {fileName && (
                                <div className="text-sm space-y-1" style={{color: '#333'}}>
                                    <p>Production Items: <span className="font-semibold">{fileName}</span></p>
                                    {shippedFileName && <p>Line Items: <span className="font-semibold">{shippedFileName}</span></p>}
                                </div>
                            )}
                        </div>

                        {Object.keys(groupedData).length > 0 && !showSizeSummary && !showReservedReport && !showCustomerSales && !showShiftsReport && !showGroupByRep && !showMissingRep && !showProductionPlanning && (
                            <div className="shadow-lg p-6 mb-6 no-print" style={{background: '#00CCFF'}}>
                                <h3 className="text-lg font-bold mb-4" style={{color: '#333'}}>Filter by Plant Name</h3>
                                
                                <div className="mb-4">
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <SearchIcon />
                                        </div>
                                        <input
                                            type="text"
                                            placeholder="Search plant names..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="w-full pl-10 pr-4 py-3 border-2 border-gray-300  focus:outline-none focus:border-[#00CCFF] text-lg"
                                        />
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <div className="flex flex-wrap gap-1 mb-3">
                                        {alphabet.map(letter => (
                                            <button
                                                key={letter}
                                                onClick={() => toggleLetter(letter)}
                                                className={`letter-button ${selectedLetters.includes(letter) ? 'active' : ''}`}
                                            >
                                                {letter}
                                            </button>
                                        ))}
                                    </div>
                                    <button
                                        onClick={clearAllFilters}
                                        className="access-button px-6 py-2 text-gray-800 font-semibold"
                                    >
                                        Clear All Filters
                                    </button>
                                </div>

                                <div className="text-sm" style={{color: '#333'}}>
                                    Showing {Object.keys(filteredGroupedData).length} of {Object.keys(groupedData).length} plants
                                </div>
                            </div>
                        )}

                        {Object.keys(filteredGroupedData).length > 0 && !showSizeSummary && !showReservedReport && !showCustomerSales && !showShiftsReport && !showGroupByRep && !showMissingRep && !showProductionPlanning && (
                            <div className="space-y-6">
                                <div className="print-only-header">
                                    <div className="print-header-line1">May Nursery</div>
                                    <div className="print-header-line2">INVENTORY LIST - ALL LOTS</div>
                                    <div className="print-header-line3">{getCurrentDateFormatted()}</div>
                                </div>
                                {Object.keys(filteredGroupedData).sort().map((plantBlock) => {
                                    const variants = filteredGroupedData[plantBlock];
                                    const sortedVariants = sortVariantsBySize(variants);
                                    return (
                                        <div key={plantBlock} className="bg-white  shadow overflow-hidden">
                                            <table className="w-full text-sm">
                                                <thead>
                                                    <tr className="border-b-2 border-gray-800">
                                                        <th className="px-3 py-2 text-left font-bold text-base">{plantBlock}</th>
                                                        <th className="px-3 py-2 text-center font-bold">Status</th>
                                                        <th className="px-3 py-2 text-center font-bold">Pull priorty</th>
                                                        <th className="px-3 py-2 text-center font-bold">Locations</th>
                                                        <th className="px-3 py-2 text-center font-bold">Ready date</th>
                                                        <th className="px-3 py-2 text-center font-bold">Qty</th>
                                                        <th className="px-3 py-2 text-center font-bold">Rsrv qty</th>
                                                        <th className="px-3 py-2 text-center font-bold">Avail qty</th>
                                                        <th className="px-3 py-2 text-center font-bold">
                                                            {Object.keys(shippedData).length > 0 ? 'Shipped YTD' : 'Pull qty'}
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {(() => {
                                                        let lastSize = null;
                                                        return Object.entries(sortedVariants).map(([variantKey, rows]) => 
                                                            rows.map((row, idx) => {
                                                                const currentSize = extractContainerSize(row.plantName);
                                                                const isFirstOfSize = currentSize !== lastSize;
                                                                lastSize = currentSize;
                                                                
                                                                return (
                                                                    <tr 
                                                                        key={`${variantKey}-${idx}`}
                                                                        className={`border-b border-gray-200 ${shouldBold(row) ? 'font-bold' : ''}`}
                                                                    >
                                                                        <td className="px-3 py-2 text-right">{row.plantName}</td>
                                                                        <td className="px-3 py-2 text-center">{row.status}</td>
                                                                        <td className="px-3 py-2 text-center">{row.pullPriority}</td>
                                                                        <td className="px-3 py-2 text-center">{row.locations}</td>
                                                                        <td className="px-3 py-2 text-center">{row.readyDate}</td>
                                                                        <td className="px-3 py-2 text-center">{row.qty}</td>
                                                                        <td className="px-3 py-2 text-center">{row.rsrvQty}</td>
                                                                        <td className="px-3 py-2 text-center">{row.availQty}</td>
                                                                        <td className="px-3 py-2 text-center">
                                                                            {Object.keys(shippedData).length > 0 
                                                                                ? (isFirstOfSize ? row.shippedYTD : '') 
                                                                                : row.pullQty}
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })
                                                        );
                                                    })()}
                                                </tbody>
                                            </table>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {showSizeSummary && Object.keys(groupedData).length > 0 && (
                            <div className="space-y-6">
                                <div className="flex justify-end mb-4">
                                    <button
                                        onClick={exportTotalCanQtyToExcel}
                                        className="inline-flex items-center gap-2 px-6 py-3 access-button transition text-gray-800 font-semibold"
                                    >
                                        <ExcelIcon />
                                        <span>Export to Excel</span>
                                    </button>
                                </div>
                                {/* Main Size Summary - All Statuses */}
                                <div className="bg-white shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Total Can Quantity - All Statuses</h2>
                                    <div className="overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b-2 border-gray-800">
                                                    <th className="px-6 py-3 text-left font-bold text-lg">Container Size</th>
                                                    <th className="px-6 py-3 text-center font-bold text-lg">Total Quantity</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {getSizeSummary().map(([size, total], idx) => (
                                                    <tr key={size} className={`border-b border-gray-200 ${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`}>
                                                        <td className="px-6 py-3 text-left font-semibold text-base">{size}</td>
                                                        <td className="px-6 py-3 text-center text-base">{total.toLocaleString()}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                            <tfoot>
                                                <tr className="border-t-2 border-gray-800 bg-gray-100">
                                                    <td className="px-6 py-4 text-left font-bold text-lg">TOTAL</td>
                                                    <td className="px-6 py-4 text-center font-bold text-lg">
                                                        {getSizeSummary().reduce((sum, [, qty]) => sum + qty, 0).toLocaleString()}
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>

                                {/* In Production - By Size */}
                                <div className="bg-white shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6">In Production - By Size</h2>
                                    <div className="overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b-2 border-gray-800">
                                                    <th className="px-6 py-3 text-left font-bold text-lg">Container Size</th>
                                                    <th className="px-6 py-3 text-center font-bold text-lg">Total Quantity</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {getSizeByStatus('In production').map(([size, total], idx) => (
                                                    <tr key={size} className={`border-b border-gray-200 ${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`}>
                                                        <td className="px-6 py-3 text-left font-semibold text-base">{size}</td>
                                                        <td className="px-6 py-3 text-center text-base">{total.toLocaleString()}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                            <tfoot>
                                                <tr className="border-t-2 border-gray-800 bg-gray-100">
                                                    <td className="px-6 py-4 text-left font-bold text-lg">TOTAL</td>
                                                    <td className="px-6 py-4 text-center font-bold text-lg">
                                                        {getSizeByStatus('In production').reduce((sum, [, qty]) => sum + qty, 0).toLocaleString()}
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>

                                {/* Ready - By Size */}
                                <div className="bg-white shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Ready - By Size</h2>
                                    <div className="overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b-2 border-gray-800">
                                                    <th className="px-6 py-3 text-left font-bold text-lg">Container Size</th>
                                                    <th className="px-6 py-3 text-center font-bold text-lg">Total Quantity</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {getSizeByStatus('Ready').map(([size, total], idx) => (
                                                    <tr key={size} className={`border-b border-gray-200 ${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`}>
                                                        <td className="px-6 py-3 text-left font-semibold text-base">{size}</td>
                                                        <td className="px-6 py-3 text-center text-base">{total.toLocaleString()}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                            <tfoot>
                                                <tr className="border-t-2 border-gray-800 bg-gray-100">
                                                    <td className="px-6 py-4 text-left font-bold text-lg">TOTAL</td>
                                                    <td className="px-6 py-4 text-center font-bold text-lg">
                                                        {getSizeByStatus('Ready').reduce((sum, [, qty]) => sum + qty, 0).toLocaleString()}
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>

                                {/* Planned - By Size */}
                                <div className="bg-white shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Planned - By Size</h2>
                                    <div className="overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b-2 border-gray-800">
                                                    <th className="px-6 py-3 text-left font-bold text-lg">Container Size</th>
                                                    <th className="px-6 py-3 text-center font-bold text-lg">Total Quantity</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {getSizeByStatus('Planned').map(([size, total], idx) => (
                                                    <tr key={size} className={`border-b border-gray-200 ${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`}>
                                                        <td className="px-6 py-3 text-left font-semibold text-base">{size}</td>
                                                        <td className="px-6 py-3 text-center text-base">{total.toLocaleString()}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                            <tfoot>
                                                <tr className="border-t-2 border-gray-800 bg-gray-100">
                                                    <td className="px-6 py-4 text-left font-bold text-lg">TOTAL</td>
                                                    <td className="px-6 py-4 text-center font-bold text-lg">
                                                        {getSizeByStatus('Planned').reduce((sum, [, qty]) => sum + qty, 0).toLocaleString()}
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {Object.keys(groupedData).length > 0 && Object.keys(filteredGroupedData).length === 0 && !showSizeSummary && !showReservedReport && !showCustomerSales && !showShiftsReport && !showGroupByRep && !showMissingRep && !showProductionPlanning && (
                            <div className="bg-white shadow-lg p-12 text-center">
                                <p className="text-gray-600 text-lg">No plants match your current filters</p>
                                <button
                                    onClick={clearAllFilters}
                                    className="mt-4 access-button px-6 py-3 text-gray-800 font-semibold"
                                >
                                    Clear Filters
                                </button>
                            </div>
                        )}

                        {showReservedReport && Object.keys(groupedData).length > 0 && (
                            <div className="bg-white shadow-lg p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">Reserved Inventory Report</h2>
                                    <button
                                        onClick={exportReservedToExcel}
                                        className="inline-flex items-center gap-2 px-6 py-3 access-button transition text-gray-800 font-semibold"
                                    >
                                        <ExcelIcon />
                                        <span>Export to Excel</span>
                                    </button>
                                </div>
                                
                                <div className="mb-6 p-4" style={{background: '#00CCFF', border: '2px solid #00A3CC'}}>
                                    <label className="block text-black font-semibold mb-2">
                                        Filter by % Reserved: {reservedPercentageMin}% - 100%
                                    </label>
                                    <input
                                        type="range"
                                        min="0"
                                        max="100"
                                        value={reservedPercentageMin}
                                        onChange={(e) => setReservedPercentageMin(parseInt(e.target.value))}
                                        className="w-full h-2 bg-white appearance-none cursor-pointer"
                                        style={{accentColor: '#2E7D32'}}
                                    />
                                    <div className="flex justify-between text-xs text-black mt-1">
                                        <span>0%</span>
                                        <span>25%</span>
                                        <span>50%</span>
                                        <span>75%</span>
                                        <span>100%</span>
                                    </div>
                                </div>
                                
                                <div className="mb-6 p-4" style={{background: '#00CCFF', border: '2px solid #00A3CC'}}>
                                    <label className="flex items-center gap-3 text-black font-semibold cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={showOnlyPriority1}
                                            onChange={(e) => setShowOnlyPriority1(e.target.checked)}
                                            className="w-5 h-5 cursor-pointer accent-green-700"
                                        />
                                        <span>Show Only Pull Priority 1</span>
                                    </label>
                                    <p className="text-sm text-black mt-2 ml-8">
                                        When enabled, only Priority 1 items will be displayed (cascading priorities 2, 3, etc. will be hidden)
                                    </p>
                                </div>
                                
                                <div className="mb-4 p-3 bg-yellow-50 border-l-4 border-yellow-400">
                                    <p className="text-sm text-gray-700">
                                        <strong>Note:</strong> Items with "Metrolina" in Inventory Notes are excluded from this report.
                                    </p>
                                </div>

                                <div className="overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b-2 border-gray-800 bg-gray-100">
                                                <th className="px-4 py-3 text-left font-bold text-base">Description</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Pull priority</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Location</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Qty</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Rsrv Qty</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">% Reserved</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Total Qty</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Total Rsrv Qty</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getReservedInventoryReport().map((row, idx) => (
                                                <tr key={idx} className={`border-b border-gray-200 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                                    <td className="px-4 py-2 text-left">{row.description}</td>
                                                    <td className="px-4 py-2 text-center">{row.priority}</td>
                                                    <td className="px-4 py-2 text-center">{row.location}</td>
                                                    <td className="px-4 py-2 text-center">{row.qty}</td>
                                                    <td className="px-4 py-2 text-center">{row.rsrvQty}</td>
                                                    <td className="px-4 py-2 text-center">{row.percentReserved.toFixed(1)}</td>
                                                    <td className="px-4 py-2 text-center font-bold">{row.totalQty !== null ? row.totalQty : ''}</td>
                                                    <td className="px-4 py-2 text-center font-bold">{row.totalRsrvQty !== null ? row.totalRsrvQty : ''}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {getReservedInventoryReport().length === 0 && (
                                        <div className="text-center py-8 text-gray-600">
                                            No items match the current percentage filter ({reservedPercentageMin}% - 100%)
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}


                        {showCustomerSales && customerSalesData.length > 0 && (
                            <div className="bg-white shadow-lg p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">Sales by Business Report</h2>
                                    <button
                                        onClick={exportCustomerSalesToExcel}
                                        className="inline-flex items-center gap-2 px-6 py-3 access-button transition text-gray-800 font-semibold"
                                    >
                                        <ExcelIcon />
                                        <span>Export to Excel</span>
                                    </button>
                                </div>
                                
                                <div className="mb-6 p-4" style={{background: '#00CCFF', border: '2px solid #00A3CC'}}>
                                    <label className="flex items-center gap-3 text-black font-semibold cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={sortCustomerByPrice}
                                            onChange={(e) => setSortCustomerByPrice(e.target.checked)}
                                            className="w-5 h-5 cursor-pointer accent-green-700"
                                        />
                                        <span>Sort by Fulfilled Sale After Credits (Descending)</span>
                                    </label>
                                    <p className="text-sm text-black mt-2 ml-8">
                                        When unchecked, results will be sorted alphabetically
                                    </p>
                                </div>

                                <div className="overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b-2 border-gray-800 bg-gray-100">
                                                <th className="px-4 py-3 text-left font-bold text-base">Customer</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">Fulfilled Sale</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">Total Credits Issued</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">Fulfilled Sale After Credits</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">% of Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getCustomerSalesSummary(false).customers.map((customer, idx) => (
                                                <tr key={idx} className={`border-b border-gray-200 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                                    <td className="px-4 py-2 text-left">{customer.customer}</td>
                                                    <td className="px-4 py-2 text-right font-semibold" style={{color: '#0066CC'}}>${customer.fulfilledSale.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                    <td className="px-4 py-2 text-right" style={{color: '#CC0000'}}>
                                                        {customer.creditsIssued > 0 ? `$${customer.creditsIssued.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}
                                                    </td>
                                                    <td className="px-4 py-2 text-right font-semibold" style={{color: '#008000'}}>${customer.fulfilledSaleAfterCredits.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                    <td className="px-4 py-2 text-right">{customer.percentOfTotal.toFixed(2)}%</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                        <tfoot>
                                            <tr className="border-t-2 border-gray-800 bg-gray-100">
                                                <td className="px-4 py-4 text-left font-bold text-lg">GRAND TOTAL</td>
                                                <td className="px-4 py-4 text-right font-bold text-lg" style={{color: '#0066CC'}}>${getCustomerSalesSummary(false).grandTotals.fulfilledSale.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                <td className="px-4 py-4 text-right font-bold text-lg" style={{color: '#CC0000'}}>${getCustomerSalesSummary(false).grandTotals.creditsIssued.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                <td className="px-4 py-4 text-right font-bold text-lg" style={{color: '#008000'}}>${getCustomerSalesSummary(false).grandTotals.fulfilledSaleAfterCredits.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                <td className="px-4 py-4 text-right font-bold text-lg">100.00%</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                    {getCustomerSalesSummary(false).customers.length === 0 && (
                                        <div className="text-center py-8 text-gray-600">
                                            No customer data available
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* GROUP BY REP REPORT - Independent */}
                        {showGroupByRep && customerSalesData.length > 0 && (
                            <div className="bg-white shadow-lg p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">Sales by Rep Report</h2>
                                    <button
                                        onClick={() => {
                                            const wb = XLSX.utils.book_new();
                                            const summary = getCustomerSalesSummary(true);
                                            const wsData = [['Sales Rep', 'Fulfilled Sale', 'Total Credits Issued', 'Fulfilled Sale After Credits', '% of Total']];
                                            summary.customers.forEach(rep => {
                                                wsData.push([
                                                    rep.customer,
                                                    rep.fulfilledSale,
                                                    rep.creditsIssued,
                                                    rep.fulfilledSaleAfterCredits,
                                                    parseFloat(rep.percentOfTotal.toFixed(2))
                                                ]);
                                            });
                                            wsData.push([
                                                'GRAND TOTAL',
                                                summary.grandTotals.fulfilledSale,
                                                summary.grandTotals.creditsIssued,
                                                summary.grandTotals.fulfilledSaleAfterCredits,
                                                100
                                            ]);
                                            const ws = XLSX.utils.aoa_to_sheet(wsData);
                                            ws['!cols'] = [{ wch: 30 }, { wch: 18 }, { wch: 22 }, { wch: 25 }, { wch: 12 }];
                                            XLSX.utils.book_append_sheet(wb, ws, "Sales Rep Summary");
                                            XLSX.writeFile(wb, `Sales_Rep_Summary_${new Date().toISOString().split('T')[0]}.xlsx`);
                                        }}
                                        className="inline-flex items-center gap-2 px-6 py-3 access-button transition text-gray-800 font-semibold"
                                    >
                                        <ExcelIcon />
                                        <span>Export to Excel</span>
                                    </button>
                                </div>
                                
                                <div className="mb-6 p-4" style={{background: '#00CCFF', border: '2px solid #00A3CC'}}>
                                    <label className="flex items-center gap-3 text-black font-semibold cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={sortCustomerByPrice}
                                            onChange={(e) => setSortCustomerByPrice(e.target.checked)}
                                            className="w-5 h-5 cursor-pointer accent-green-700"
                                        />
                                        <span>Sort by Fulfilled Sale After Credits (Descending)</span>
                                    </label>
                                    <p className="text-sm text-black mt-2 ml-8">
                                        When unchecked, results will be sorted alphabetically
                                    </p>
                                </div>

                                <div className="overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b-2 border-gray-800 bg-gray-100">
                                                <th className="px-4 py-3 text-left font-bold text-base">Sales Rep</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">Fulfilled Sale</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">Total Credits Issued</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">Fulfilled Sale After Credits</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">% of Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getCustomerSalesSummary(true).customers.map((rep, idx) => (
                                                <tr key={idx} className={`border-b border-gray-200 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                                    <td className="px-4 py-2 text-left">{rep.customer}</td>
                                                    <td className="px-4 py-2 text-right font-semibold" style={{color: '#0066CC'}}>${rep.fulfilledSale.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                    <td className="px-4 py-2 text-right" style={{color: '#CC0000'}}>
                                                        {rep.creditsIssued > 0 ? `$${rep.creditsIssued.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}
                                                    </td>
                                                    <td className="px-4 py-2 text-right font-semibold" style={{color: '#008000'}}>${rep.fulfilledSaleAfterCredits.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                    <td className="px-4 py-2 text-right">{rep.percentOfTotal.toFixed(2)}%</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                        <tfoot>
                                            <tr className="border-t-2 border-gray-800 bg-gray-100">
                                                <td className="px-4 py-4 text-left font-bold text-lg">GRAND TOTAL</td>
                                                <td className="px-4 py-4 text-right font-bold text-lg" style={{color: '#0066CC'}}>${getCustomerSalesSummary(true).grandTotals.fulfilledSale.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                <td className="px-4 py-4 text-right font-bold text-lg" style={{color: '#CC0000'}}>${getCustomerSalesSummary(true).grandTotals.creditsIssued.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                <td className="px-4 py-4 text-right font-bold text-lg" style={{color: '#008000'}}>${getCustomerSalesSummary(true).grandTotals.fulfilledSaleAfterCredits.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                <td className="px-4 py-4 text-right font-bold text-lg">100.00%</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                    {getCustomerSalesSummary(true).customers.length === 0 && (
                                        <div className="text-center py-8 text-gray-600">
                                            No sales rep data available
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* MISSING REP REPORT - Independent */}
                        {showMissingRep && customerSalesData.length > 0 && (
                            <div className="bg-white shadow-lg p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">Unknown Rep Report</h2>
                                    <button
                                        onClick={() => {
                                            const wb = XLSX.utils.book_new();
                                            const items = getEmptySalesRepItems();
                                            const wsData = [['Order ID', 'Customer', 'Extended Price', 'Total Credits Issued', 'Total Sold']];
                                            items.forEach(item => {
                                                wsData.push([
                                                    item.orderId,
                                                    item.customer,
                                                    item.extendedPrice,
                                                    item.creditsIssued,
                                                    item.totalSold
                                                ]);
                                            });
                                            const ws = XLSX.utils.aoa_to_sheet(wsData);
                                            ws['!cols'] = [{ wch: 15 }, { wch: 30 }, { wch: 15 }, { wch: 20 }, { wch: 15 }];
                                            XLSX.utils.book_append_sheet(wb, ws, "Missing Rep");
                                            XLSX.writeFile(wb, `Missing_Rep_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
                                        }}
                                        className="inline-flex items-center gap-2 px-6 py-3 access-button transition text-gray-800 font-semibold"
                                    >
                                        <ExcelIcon />
                                        <span>Export to Excel</span>
                                    </button>
                                </div>

                                <div className="mb-4 p-3 bg-yellow-50 border-l-4 border-yellow-400">
                                    <p className="text-sm text-gray-700">
                                        <strong>Note:</strong> These are orders that are missing a sales rep assignment. Each Order ID + Customer combination appears once with quantities summed. Showing {getEmptySalesRepItems().length} unique orders.
                                    </p>
                                </div>
                                
                                <div className="overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b-2 border-gray-800 bg-gray-100">
                                                <th className="px-4 py-3 text-left font-bold text-base">Order ID</th>
                                                <th className="px-4 py-3 text-left font-bold text-base">Customer</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">Extended Price</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">Total Credits Issued</th>
                                                <th className="px-4 py-3 text-right font-bold text-base">Total Sold</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getEmptySalesRepItems().map((item, idx) => (
                                                <tr key={idx} className={`border-b border-gray-200 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                                    <td className="px-4 py-2 text-left font-mono text-xs">{item.orderId}</td>
                                                    <td className="px-4 py-2 text-left">{item.customer}</td>
                                                    <td className="px-4 py-2 text-right" style={{color: '#0066CC'}}>${item.extendedPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                    <td className="px-4 py-2 text-right" style={{color: '#CC0000'}}>
                                                        {item.creditsIssued > 0 ? `$${item.creditsIssued.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}
                                                    </td>
                                                    <td className="px-4 py-2 text-right font-semibold" style={{color: '#008000'}}>${item.totalSold.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {getEmptySalesRepItems().length === 0 && (
                                        <div className="text-center py-8 text-gray-600">
                                            No orders with missing sales rep found! 
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {showShiftsReport && (
                            <div className="bg-white shadow-lg p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">Shifts Report</h2>
                                    <button
                                        onClick={exportShiftsReportToExcel}
                                        className="inline-flex items-center gap-2 px-6 py-3 access-button transition text-gray-800 font-semibold"
                                    >
                                        <ExcelIcon />
                                        <span>Export to Excel</span>
                                    </button>
                                </div>
                                
                                <div className="mb-4 p-3 bg-blue-50 border-l-4 border-blue-400">
                                    <p className="text-sm text-gray-700">
                                        <strong>This report shows:</strong> Each line item with "shift" in Customer name (from Line Items) and each location with Withheld qty &gt; 0 (from Production Items) displayed on separate rows. Location column shows where withheld items are stored.
                                    </p>
                                </div>

                                <div className="overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b-2 border-gray-800 bg-gray-100">
                                                <th className="px-4 py-3 text-left font-bold text-base">Product Variant</th>
                                                <th className="px-4 py-3 text-left font-bold text-base">Customer</th>
                                                <th className="px-4 py-3 text-left font-bold text-base">Location</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Confirmed Qty</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Allocated</th>
                                                <th className="px-4 py-3 text-left font-bold text-base">Withheld Notes</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Withheld Qty</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Future Shift Qty</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getShiftsReport().map((row, idx) => (
                                                <tr key={idx} className={`border-b border-gray-200 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                                    <td className="px-4 py-2 text-left">{row.productVariant}</td>
                                                    <td className="px-4 py-2 text-left">{row.customer}</td>
                                                    <td className="px-4 py-2 text-left">{row.location}</td>
                                                    <td className="px-4 py-2 text-center">{row.confirmed || ''}</td>
                                                    <td className="px-4 py-2 text-center">{row.allocated || ''}</td>
                                                    <td className="px-4 py-2 text-left">{row.withheldNotes}</td>
                                                    <td className="px-4 py-2 text-center">{row.withheldQty || ''}</td>
                                                    <td className="px-4 py-2 text-center font-semibold">{row.futureShiftQty || 0}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {getShiftsReport().length === 0 && (
                                        <div className="text-center py-8 text-gray-600">
                                            No matching data found. Make sure both Production Items CSV and Line Items CSV are uploaded.
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {showProductionPlanning && (
                            <div className="bg-white shadow-lg p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">Production Planning Report</h2>
                                    <button
                                        onClick={exportProductionPlanningToExcel}
                                        className="inline-flex items-center gap-2 px-6 py-3 access-button transition text-gray-800 font-semibold"
                                    >
                                        <ExcelIcon />
                                        <span>Export to Excel</span>
                                    </button>
                                </div>
                                
                                <div className="mb-4 p-3 bg-blue-50 border-l-4 border-blue-400">
                                    <p className="text-sm text-gray-700">
                                        <strong>This report shows:</strong> Total quantity for each Product/Variant across all statuses, broken down by In Production and Ready statuses, along with Shipped YTD and Future Shift Qty (allocated for shifts + withheld inventory). When Fulfilled Sales Report is uploaded, a Past N-Year Average and historical sales by year are displayed (toggle individual years on/off using the buttons below).
                                    </p>
                                </div>

                                {(() => {
                                    const reportData = getProductionPlanningReport();
                                    const yearCols = reportData.soldYearColumns || [];
                                    
                                    if (yearCols.length > 0) {
                                        return (
                                            <div className="mb-4 p-4 bg-gray-50 border border-gray-300 rounded">
                                                <div className="mb-3">
                                                    <label className="text-sm font-semibold text-gray-700 mr-3">
                                                        Year Average:
                                                    </label>
                                                    <select 
                                                        value={yearAverageCount}
                                                        onChange={(e) => setYearAverageCount(parseInt(e.target.value))}
                                                        className="px-3 py-1 border border-gray-300 rounded text-sm"
                                                    >
                                                        <option value={2}>Past 2 Years</option>
                                                        <option value={3}>Past 3 Years</option>
                                                        <option value={4}>Past 4 Years</option>
                                                        <option value={5}>Past 5 Years</option>
                                                    </select>
                                                </div>
                                                
                                                <div className="mb-2">
                                                    <span className="text-sm font-semibold text-gray-700 mr-3">Toggle Year Columns:</span>
                                                </div>
                                                <div className="flex flex-wrap gap-2">
                                                    {yearCols.map(yearCol => (
                                                        <button
                                                            key={yearCol}
                                                            onClick={() => {
                                                                const newVisible = new Set(visibleYearColumns);
                                                                if (newVisible.has(yearCol)) {
                                                                    newVisible.delete(yearCol);
                                                                } else {
                                                                    newVisible.add(yearCol);
                                                                }
                                                                setVisibleYearColumns(newVisible);
                                                            }}
                                                            className={`px-3 py-1 text-sm font-semibold rounded transition ${
                                                                visibleYearColumns.has(yearCol)
                                                                    ? 'bg-blue-500 text-white border border-blue-600'
                                                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                                            }`}
                                                        >
                                                            {yearCol}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    }
                                    return null;
                                })()}

                                {/* Column Visibility Toggles */}
                                <div className="mb-4 p-4 bg-gray-50 border border-gray-300 rounded">
                                    <div className="mb-2">
                                        <span className="text-sm font-semibold text-gray-700 mr-3">Toggle Main Columns:</span>
                                    </div>
                                    <div className="flex flex-wrap gap-2 mb-4">
                                        <button
                                            onClick={() => setShowShippedYTD(!showShippedYTD)}
                                            className={`px-3 py-1 text-sm font-semibold rounded transition ${
                                                showShippedYTD
                                                    ? 'bg-blue-500 text-white border border-blue-600'
                                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                            }`}
                                        >
                                            Shipped YTD
                                        </button>
                                        <button
                                            onClick={() => setShowInProductionQty(!showInProductionQty)}
                                            className={`px-3 py-1 text-sm font-semibold rounded transition ${
                                                showInProductionQty
                                                    ? 'bg-blue-500 text-white border border-blue-600'
                                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                            }`}
                                        >
                                            In Production Qty
                                        </button>
                                        <button
                                            onClick={() => setShowReadyQty(!showReadyQty)}
                                            className={`px-3 py-1 text-sm font-semibold rounded transition ${
                                                showReadyQty
                                                    ? 'bg-blue-500 text-white border border-blue-600'
                                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                            }`}
                                        >
                                            Ready Qty
                                        </button>
                                        <button
                                            onClick={() => setShowFutureShiftQty(!showFutureShiftQty)}
                                            className={`px-3 py-1 text-sm font-semibold rounded transition ${
                                                showFutureShiftQty
                                                    ? 'bg-blue-500 text-white border border-blue-600'
                                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                            }`}
                                        >
                                            Future Shift Qty
                                        </button>
                                        <button
                                            onClick={() => setShowProjectedQty(!showProjectedQty)}
                                            className={`px-3 py-1 text-sm font-semibold rounded transition ${
                                                showProjectedQty
                                                    ? 'bg-blue-500 text-white border border-blue-600'
                                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                            }`}
                                        >
                                            Projected Qty
                                        </button>
                                    </div>
                                    
                                    {/* Ready Date Grouping Toggles */}
                                    <div className="mb-2 mt-4">
                                        <span className="text-sm font-semibold text-gray-700 mr-3">Ready Date Groupings (In Production):</span>
                                    </div>
                                    <div className="flex gap-4 mb-3">
                                        <button
                                            onClick={() => setShowReadyMonthColumns(!showReadyMonthColumns)}
                                            className={`px-4 py-2 text-sm font-semibold rounded transition ${
                                                showReadyMonthColumns
                                                    ? 'bg-green-500 text-white border border-green-600'
                                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                            }`}
                                        >
                                            {showReadyMonthColumns ? 'Hide' : 'Show'} Month Columns
                                        </button>
                                        <button
                                            onClick={() => setShowReadySeasonColumns(!showReadySeasonColumns)}
                                            className={`px-4 py-2 text-sm font-semibold rounded transition ${
                                                showReadySeasonColumns
                                                    ? 'bg-green-500 text-white border border-green-600'
                                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                            }`}
                                        >
                                            {showReadySeasonColumns ? 'Hide' : 'Show'} Season Columns
                                        </button>
                                    </div>
                                    
                                    {/* Ready Month Toggles - 3 years */}
                                    {showReadyMonthColumns && (
                                        <div className="mb-3">
                                            <div className="mb-1">
                                                <span className="text-xs font-semibold text-gray-600 mr-2">Toggle Ready Date Months:</span>
                                            </div>
                                            {(() => {
                                                const currentYear = new Date().getFullYear();
                                                const years = [currentYear, currentYear + 1, currentYear + 2];
                                                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                
                                                return years.map(year => (
                                                    <div key={year} className="mb-2">
                                                        <div className="text-xs font-semibold text-gray-500 mb-1">{year}:</div>
                                                        <div className="flex flex-wrap gap-1">
                                                            {months.map(month => {
                                                                const key = `${month} ${year}`;
                                                                return (
                                                                    <button
                                                                        key={key}
                                                                        onClick={() => {
                                                                            const newVisible = new Set(visibleReadyMonths);
                                                                            if (newVisible.has(key)) {
                                                                                newVisible.delete(key);
                                                                            } else {
                                                                                newVisible.add(key);
                                                                            }
                                                                            setVisibleReadyMonths(newVisible);
                                                                        }}
                                                                        className={`px-2 py-1 text-xs font-semibold rounded transition ${
                                                                            visibleReadyMonths.has(key)
                                                                                ? 'bg-indigo-500 text-white border border-indigo-600'
                                                                                : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                                                        }`}
                                                                    >
                                                                        {month}
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                ));
                                            })()}
                                        </div>
                                    )}
                                    
                                    {/* Ready Season Toggles - 3 years */}
                                    {showReadySeasonColumns && (
                                        <div className="mb-3">
                                            <div className="mb-1">
                                                <span className="text-xs font-semibold text-gray-600 mr-2">Toggle Ready Date Seasons:</span>
                                            </div>
                                            {(() => {
                                                const currentYear = new Date().getFullYear();
                                                const years = [currentYear, currentYear + 1, currentYear + 2];
                                                const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                                                
                                                return years.map(year => (
                                                    <div key={year} className="mb-2">
                                                        <div className="text-xs font-semibold text-gray-500 mb-1">{year}:</div>
                                                        <div className="flex flex-wrap gap-2">
                                                            {seasons.map(season => {
                                                                const key = `${season} ${year}`;
                                                                return (
                                                                    <button
                                                                        key={key}
                                                                        onClick={() => {
                                                                            const newVisible = new Set(visibleReadySeasons);
                                                                            if (newVisible.has(key)) {
                                                                                newVisible.delete(key);
                                                                            } else {
                                                                                newVisible.add(key);
                                                                            }
                                                                            setVisibleReadySeasons(newVisible);
                                                                        }}
                                                                        className={`px-3 py-1 text-sm font-semibold rounded transition ${
                                                                            visibleReadySeasons.has(key)
                                                                                ? 'bg-pink-500 text-white border border-pink-600'
                                                                                : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                                        }`}
                                                                    >
                                                                        {season}
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                ));
                                            })()}
                                        </div>
                                    )}
                                    
                                    {/* Start Date Grouping Toggles */}
                                    <div className="mb-2 mt-4">
                                        <span className="text-sm font-semibold text-gray-700 mr-3">Start Date Groupings:</span>
                                    </div>
                                    <div className="flex gap-4 mb-3">
                                        <button
                                            onClick={() => setShowStartMonthColumns(!showStartMonthColumns)}
                                            className={`px-4 py-2 text-sm font-semibold rounded transition ${
                                                showStartMonthColumns
                                                    ? 'bg-green-500 text-white border border-green-600'
                                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                            }`}
                                        >
                                            {showStartMonthColumns ? 'Hide' : 'Show'} Month Columns
                                        </button>
                                        <button
                                            onClick={() => setShowStartSeasonColumns(!showStartSeasonColumns)}
                                            className={`px-4 py-2 text-sm font-semibold rounded transition ${
                                                showStartSeasonColumns
                                                    ? 'bg-green-500 text-white border border-green-600'
                                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                            }`}
                                        >
                                            {showStartSeasonColumns ? 'Hide' : 'Show'} Season Columns
                                        </button>
                                    </div>
                                    
                                    {/* Month Toggles - 3 years */}
                                    {showStartMonthColumns && (
                                        <div className="mb-3">
                                            <div className="mb-1">
                                                <span className="text-xs font-semibold text-gray-600 mr-2">Toggle Months:</span>
                                            </div>
                                            {(() => {
                                                const currentYear = new Date().getFullYear();
                                                const years = [currentYear, currentYear + 1, currentYear + 2];
                                                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                
                                                return years.map(year => (
                                                    <div key={year} className="mb-2">
                                                        <div className="text-xs font-semibold text-gray-500 mb-1">{year}:</div>
                                                        <div className="flex flex-wrap gap-1">
                                                            {months.map(month => {
                                                                const key = `${month} ${year}`;
                                                                return (
                                                                    <button
                                                                        key={key}
                                                                        onClick={() => {
                                                                            const newVisible = new Set(visibleStartMonths);
                                                                            if (newVisible.has(key)) {
                                                                                newVisible.delete(key);
                                                                            } else {
                                                                                newVisible.add(key);
                                                                            }
                                                                            setVisibleStartMonths(newVisible);
                                                                        }}
                                                                        className={`px-2 py-1 text-xs font-semibold rounded transition ${
                                                                            visibleStartMonths.has(key)
                                                                                ? 'bg-purple-500 text-white border border-purple-600'
                                                                                : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                                                        }`}
                                                                    >
                                                                        {month}
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                ));
                                            })()}
                                        </div>
                                    )}
                                    
                                    {/* Season Toggles - 3 years */}
                                    {showStartSeasonColumns && (
                                        <div>
                                            <div className="mb-1">
                                                <span className="text-xs font-semibold text-gray-600 mr-2">Toggle Seasons:</span>
                                            </div>
                                            {(() => {
                                                const currentYear = new Date().getFullYear();
                                                const years = [currentYear, currentYear + 1, currentYear + 2];
                                                const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                                                
                                                return years.map(year => (
                                                    <div key={year} className="mb-2">
                                                        <div className="text-xs font-semibold text-gray-500 mb-1">{year}:</div>
                                                        <div className="flex flex-wrap gap-2">
                                                            {seasons.map(season => {
                                                                const key = `${season} ${year}`;
                                                                return (
                                                                    <button
                                                                        key={key}
                                                                        onClick={() => {
                                                                            const newVisible = new Set(visibleStartSeasons);
                                                                            if (newVisible.has(key)) {
                                                                                newVisible.delete(key);
                                                                            } else {
                                                                                newVisible.add(key);
                                                                            }
                                                                            setVisibleStartSeasons(newVisible);
                                                                        }}
                                                                        className={`px-3 py-1 text-sm font-semibold rounded transition ${
                                                                            visibleStartSeasons.has(key)
                                                                                ? 'bg-orange-500 text-white border border-orange-600'
                                                                                : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
                                                                        }`}
                                                                    >
                                                                        {season}
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                ));
                                            })()}
                                        </div>
                                    )}
                                </div>

                                <div className="overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b-2 border-gray-800 bg-gray-100">
                                                <th className="px-4 py-3 text-left font-bold text-base">Description</th>
                                                <th className="px-4 py-3 text-center font-bold text-base">Total Qty</th>
                                                {showInProductionQty && <th className="px-4 py-3 text-center font-bold text-base">In Production Qty</th>}
                                                {showReadyQty && <th className="px-4 py-3 text-center font-bold text-base">Ready Qty</th>}
                                                {showShippedYTD && <th className="px-4 py-3 text-center font-bold text-base">Shipped YTD</th>}
                                                {showFutureShiftQty && <th className="px-4 py-3 text-center font-bold text-base">Future Shift Qty</th>}
                                                {(() => {
                                                    const reportData = getProductionPlanningReport();
                                                    const yearCols = reportData.soldYearColumns || [];
                                                    
                                                    // Add Past N-Year Average column if there are year columns
                                                    const headers = [];
                                                    if (yearCols.length > 0) {
                                                        headers.push(
                                                            <th key="yearAverage" className="px-4 py-3 text-center font-bold text-base bg-green-100">
                                                                Past {yearAverageCount}-Year Avg
                                                            </th>
                                                        );
                                                        
                                                        // Add Projected Qty column (sum of past 3 years)
                                                        if (showProjectedQty) {
                                                            headers.push(
                                                                <th key="projectedQty" className="px-4 py-3 text-center font-bold text-base bg-yellow-100">
                                                                    Projected Qty
                                                                </th>
                                                            );
                                                        }
                                                    }
                                                    
                                                    // Add visible year columns
                                                    yearCols.forEach(yearCol => {
                                                        if (visibleYearColumns.has(yearCol)) {
                                                            headers.push(
                                                                <th key={yearCol} className="px-4 py-3 text-center font-bold text-base">{yearCol}</th>
                                                            );
                                                        }
                                                    });
                                                    
                                                    // Add Ready date month columns if enabled
                                                    if (showReadyMonthColumns) {
                                                        const currentYear = new Date().getFullYear();
                                                        const years = [currentYear, currentYear + 1, currentYear + 2];
                                                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                        
                                                        years.forEach(year => {
                                                            months.forEach(month => {
                                                                const key = `${month} ${year}`;
                                                                if (visibleReadyMonths.has(key)) {
                                                                    headers.push(
                                                                        <th key={'ready-month-' + month + year} className="px-3 py-3 text-center font-bold text-xs bg-indigo-50">
                                                                            {month} {year}
                                                                        </th>
                                                                    );
                                                                }
                                                            });
                                                        });
                                                    }
                                                    
                                                    // Add Ready date season columns if enabled
                                                    if (showReadySeasonColumns) {
                                                        const currentYear = new Date().getFullYear();
                                                        const years = [currentYear, currentYear + 1, currentYear + 2];
                                                        const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                                                        
                                                        years.forEach(year => {
                                                            seasons.forEach(season => {
                                                                const key = `${season} ${year}`;
                                                                if (visibleReadySeasons.has(key)) {
                                                                    headers.push(
                                                                        <th key={'ready-season-' + season + year} className="px-3 py-3 text-center font-bold text-xs bg-pink-50">
                                                                            {season} {year}
                                                                        </th>
                                                                    );
                                                                }
                                                            });
                                                        });
                                                    }
                                                    
                                                    // Add Start date month columns if enabled
                                                    if (showStartMonthColumns) {
                                                        const currentYear = new Date().getFullYear();
                                                        const years = [currentYear, currentYear + 1, currentYear + 2];
                                                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                        
                                                        years.forEach(year => {
                                                            months.forEach(month => {
                                                                const key = `${month} ${year}`;
                                                                if (visibleStartMonths.has(key)) {
                                                                    headers.push(
                                                                        <th key={'start-month-' + month + year} className="px-3 py-3 text-center font-bold text-xs bg-purple-50">
                                                                            {month} {year}
                                                                        </th>
                                                                    );
                                                                }
                                                            });
                                                        });
                                                    }
                                                    
                                                    // Add Start date season columns if enabled
                                                    if (showStartSeasonColumns) {
                                                        const currentYear = new Date().getFullYear();
                                                        const years = [currentYear, currentYear + 1, currentYear + 2];
                                                        const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                                                        
                                                        years.forEach(year => {
                                                            seasons.forEach(season => {
                                                                const key = `${season} ${year}`;
                                                                if (visibleStartSeasons.has(key)) {
                                                                    headers.push(
                                                                        <th key={'start-season-' + season + year} className="px-3 py-3 text-center font-bold text-xs bg-orange-50">
                                                                            {season} {year}
                                                                        </th>
                                                                    );
                                                                }
                                                            });
                                                        });
                                                    }
                                                    
                                                    return headers;
                                                })()}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                const reportData = getProductionPlanningReport();
                                                const yearCols = reportData.soldYearColumns || [];
                                                return reportData.map((row, idx) => (
                                                    <tr key={idx} className={`border-b border-gray-200 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                                        <td className="px-4 py-2 text-left">{row.description}</td>
                                                        <td className="px-4 py-2 text-center font-semibold">{row.totalQty.toLocaleString()}</td>
                                                        {showInProductionQty && <td className="px-4 py-2 text-center">{row.inProductionQty.toLocaleString()}</td>}
                                                        {showReadyQty && <td className="px-4 py-2 text-center">{row.readyQty.toLocaleString()}</td>}
                                                        {showShippedYTD && <td className="px-4 py-2 text-center">{row.shippedYTD.toLocaleString()}</td>}
                                                        {showFutureShiftQty && <td className="px-4 py-2 text-center font-semibold">{row.futureShiftQty.toLocaleString()}</td>}
                                                        {(() => {
                                                            const cells = [];
                                                            
                                                            // Add Past N-Year Average column if there are year columns
                                                            if (yearCols.length > 0) {
                                                                cells.push(
                                                                    <td key="yearAverage" className="px-4 py-2 text-center font-semibold bg-green-50">
                                                                        {(row.yearAverage || 0).toLocaleString()}
                                                                    </td>
                                                                );
                                                                
                                                                // Add Projected Qty column (sum of past 3 years)
                                                                if (showProjectedQty) {
                                                                    cells.push(
                                                                        <td key="projectedQty" className="px-4 py-2 text-center font-semibold bg-yellow-50">
                                                                            {(row.projectedQty || 0).toLocaleString()}
                                                                        </td>
                                                                    );
                                                                }
                                                            }
                                                            
                                                            // Add visible year columns
                                                            yearCols.forEach(yearCol => {
                                                                if (visibleYearColumns.has(yearCol)) {
                                                                    cells.push(
                                                                        <td key={yearCol} className="px-4 py-2 text-center">
                                                                            {(row[yearCol] || 0).toLocaleString()}
                                                                        </td>
                                                                    );
                                                                }
                                                            });
                                                            
                                                            // Add Ready date month columns if enabled
                                                            if (showReadyMonthColumns) {
                                                                const currentYear = new Date().getFullYear();
                                                                const years = [currentYear, currentYear + 1, currentYear + 2];
                                                                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                                
                                                                years.forEach(year => {
                                                                    months.forEach(month => {
                                                                        const key = `${month} ${year}`;
                                                                        if (visibleReadyMonths.has(key)) {
                                                                            cells.push(
                                                                                <td key={'ready-month-' + month + year} className="px-3 py-2 text-center text-xs bg-indigo-50">
                                                                                    {(row[`ready${month}${year}`] || 0).toLocaleString()}
                                                                                </td>
                                                                            );
                                                                        }
                                                                    });
                                                                });
                                                            }
                                                            
                                                            // Add Ready date season columns if enabled
                                                            if (showReadySeasonColumns) {
                                                                const currentYear = new Date().getFullYear();
                                                                const years = [currentYear, currentYear + 1, currentYear + 2];
                                                                const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                                                                
                                                                years.forEach(year => {
                                                                    seasons.forEach(season => {
                                                                        const key = `${season} ${year}`;
                                                                        if (visibleReadySeasons.has(key)) {
                                                                            cells.push(
                                                                                <td key={'ready-season-' + season + year} className="px-3 py-2 text-center text-xs bg-pink-50">
                                                                                    {(row[`ready${season}${year}`] || 0).toLocaleString()}
                                                                                </td>
                                                                            );
                                                                        }
                                                                    });
                                                                });
                                                            }
                                                            
                                                            // Add Start date month columns if enabled
                                                            if (showStartMonthColumns) {
                                                                const currentYear = new Date().getFullYear();
                                                                const years = [currentYear, currentYear + 1, currentYear + 2];
                                                                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                                
                                                                years.forEach(year => {
                                                                    months.forEach(month => {
                                                                        const key = `${month} ${year}`;
                                                                        if (visibleStartMonths.has(key)) {
                                                                            cells.push(
                                                                                <td key={'start-month-' + month + year} className="px-3 py-2 text-center text-xs bg-purple-50">
                                                                                    {(row[`start${month}${year}`] || 0).toLocaleString()}
                                                                                </td>
                                                                            );
                                                                        }
                                                                    });
                                                                });
                                                            }
                                                            
                                                            // Add Start date season columns if enabled
                                                            if (showStartSeasonColumns) {
                                                                const currentYear = new Date().getFullYear();
                                                                const years = [currentYear, currentYear + 1, currentYear + 2];
                                                                const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                                                                
                                                                years.forEach(year => {
                                                                    seasons.forEach(season => {
                                                                        const key = `${season} ${year}`;
                                                                        if (visibleStartSeasons.has(key)) {
                                                                            cells.push(
                                                                                <td key={'start-season-' + season + year} className="px-3 py-2 text-center text-xs bg-orange-50">
                                                                                    {(row[`start${season}${year}`] || 0).toLocaleString()}
                                                                                </td>
                                                                            );
                                                                        }
                                                                    });
                                                                });
                                                            }
                                                            
                                                            return cells;
                                                        })()}
                                                    </tr>
                                                ));
                                            })()}
                                        </tbody>
                                    </table>
                                    {getProductionPlanningReport().length === 0 && (
                                        <div className="text-center py-8 text-gray-600">
                                            No data found. Make sure Production Items CSV is uploaded.
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {Object.keys(groupedData).length === 0 && data.length === 0 && (
                            <div className="bg-white shadow-lg p-12 text-center">
                                <div className="mx-auto mb-4 text-gray-400 flex justify-center">
                                    <Upload />
                                </div>
                                <p className="text-gray-600 text-lg">Upload a CSV file to get started</p>
                                <p className="text-gray-500 text-sm mt-2">Expected columns: Product, Variant, Status, Qty, Locations, Ready date, Pull priorty, etc.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<InventoryReportFormatter />, document.getElementById('root'));
    </script>
</body>
</html>
